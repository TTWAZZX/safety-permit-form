<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏£‡∏õ‡∏†.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ================= THEME VARIABLES ================= */
        :root {
            --primary-color: #0ea5e9;
            --line-green: #06c755;
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-color: #334155;
            --input-bg: #fff;
            --border-color: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.8);
            --text-color: #f1f5f9;
            --input-bg: #1e293b;
            --border-color: #334155;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh; 
            padding-bottom: 20px; 
            transition: background-color 0.3s ease;
        }
        
        .container { max-width: 500px; padding: 0 15px; display: none; }

        /* ================= LOADING SCREEN ================= */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .line-spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--line-green);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text-main { font-weight: bold; font-size: 1.2rem; color: var(--text-color); margin-bottom: 5px; }
        .loading-text-sub { font-size: 0.9rem; color: #888; }

        /* ================= CARD & INPUTS ================= */
        .main-card {
            margin-top: 20px;
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 24px; padding: 25px 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            position: relative; overflow: hidden;
        }
        .main-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #1e3a8a, #0ea5e9); }

        .form-floating > .form-control, .form-floating > .form-select { 
            border-radius: 12px; border: 1px solid var(--border-color); 
            background-color: var(--input-bg); color: var(--text-color); height: 60px; 
        }
        .form-floating > .form-control:focus, .form-floating > .form-select:focus { 
            border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); 
        }
        .form-floating > label { color: #94a3b8; }
        
        /* TomSelect Theme Fix for Dark Mode */
        .ts-control { border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-color); padding: 16px 12px; }
        .ts-dropdown { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; }
        .ts-dropdown .active { background-color: rgba(14, 165, 233, 0.1); color: var(--text-color); }

        .btn-submit { 
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; width: 100%; 
            border-radius: 16px; padding: 14px; border: none; font-weight: 700; font-size: 1.1rem; margin-top: 10px;
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
        }

        .theme-toggle {
            position: absolute; top: 20px; right: 20px;
            background: rgba(14, 165, 233, 0.1); color: var(--primary-color);
            border: none; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* ================= HISTORY LIST ================= */
        .history-item { 
            background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; 
            border-left: 4px solid var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); 
        }
        
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
            border-radius: 8px; color: transparent !important; min-height: 1em;
        }
        [data-theme="dark"] .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="line-spinner"></div>
    <div class="loading-text-main" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE</div>
    <div class="loading-text-sub" id="loadStatusSub">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
</div>

<div class="container animate__animated animate__fadeIn" id="mainApp">
    <div class="main-card">
        <button class="theme-toggle" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i></button>

        <div class="text-center mb-4">
            <div class="bg-primary bg-opacity-10 p-2 rounded-circle d-inline-block mb-2 shadow-sm">
                <img id="profileImage" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="rounded-circle" width="45">
            </div>
            <h5 class="fw-bold m-0 text-gradient text-primary">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</h5>
            <small class="opacity-75">Smart Security Attendance</small>
        </div>

        <form id="attendanceForm">
            <input type="hidden" id="userId">

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="form-floating">
                        <input type="date" id="work_date" class="form-control" required>
                        <label for="work_date"><i class="bi bi-calendar3 me-1"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating">
                        <select id="shift" class="form-select" required>
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞...</option>
                            <option value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (07:00-19:00)">‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</option>
                            <option value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (19:00-07:00)">üåô ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å</option>
                        </select>
                        <label for="shift"><i class="bi bi-arrow-repeat me-1"></i>‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted fw-bold mb-1"><i class="bi bi-credit-card-2-front me-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡πÅ‡∏Å‡∏ô (ID Card)</label>
                <select id="id_card" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£..."></select>
            </div>

            <div class="mb-3">
                <label class="small text-muted fw-bold mb-1"><i class="bi bi-person-badge me-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)</label>
                <select id="fullname" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•..."></select>
            </div>

            <div class="row g-2 mb-3 mt-2">
                <div class="col-6">
                    <div class="form-floating">
                        <input type="time" id="time_in" class="form-control fw-bold text-success">
                        <label for="time_in"><i class="bi bi-box-arrow-in-right me-1"></i>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating">
                        <input type="time" id="time_out" class="form-control fw-bold text-danger">
                        <label for="time_out"><i class="bi bi-box-arrow-right me-1"></i>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                    </div>
                </div>
            </div>

            <div class="form-floating mb-3">
                <select id="remark_type" class="form-select" onchange="handleRemarkChange()">
                    <option value="‡∏õ‡∏Å‡∏ï‡∏¥" selected>‚úÖ ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                    <option value="‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)">‚≠ê ‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)</option>
                    <option value="‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)">üîÑ ‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                </select>
                <label for="remark_type"><i class="bi bi-card-text me-1"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            </div>

            <div class="form-floating mb-3 d-none" id="remark_other_div">
                <input type="text" id="remark_detail" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                <label for="remark_detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...</label>
            </div>

            <button type="submit" id="btnSubmit" class="btn-submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="bi bi-send-fill ms-2"></i></button>
        </form>
    </div>

    <div class="mt-4 pb-4">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h6 class="fw-bold opacity-75 m-0 small text-uppercase"><i class="bi bi-clock-history me-1"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
        </div>
        <div id="historyList">
            <div class="history-item"><div class="skeleton" style="width: 100%;">Loading...</div></div>
        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
// üõë ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà KEY ‡πÅ‡∏•‡∏∞ LIFF ID!
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const LIFF_ID = '2007053300-gJitj7Vr'; 

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= INIT =================
window.onload = async () => {
    initTheme();
    document.getElementById('work_date').valueAsDate = new Date(); // ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

    await updateLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...", 800);
    
    try {
        await liff.init({ liffId: LIFF_ID });
        await updateLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...", 800);
        
        if (!liff.isLoggedIn()) { 
            liff.login(); 
            return; 
        }

        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        if(profile.pictureUrl) document.getElementById('profileImage').src = profile.pictureUrl;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏õ‡∏†. ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)
        await Promise.all([loadMasterData(), fetchRecentHistory()]);

        // ‡∏ã‡πà‡∏≠‡∏ô Loading Screen
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

    } catch (err) { 
        console.error('LIFF Error:', err);
        // Fallback
        await loadMasterData();
        await fetchRecentHistory();
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    }
};

function updateLoader(text, delay) {
    return new Promise(resolve => {
        document.getElementById('loadStatusMain').innerText = text;
        setTimeout(resolve, delay);
    });
}

// ================= THEME TOGGLE =================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}

// ================= APP LOGIC =================
async function loadMasterData() {
    try {
        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£
        const { data: cards } = await db.from('security_card_master').select('card_number').order('card_number');
        const selectCard = document.getElementById('id_card');
        selectCard.innerHTML = '<option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£...</option>';
        if (cards) {
            cards.forEach(c => {
                selectCard.innerHTML += `<option value="${c.card_number}">${c.card_number}</option>`;
            });
        }
        new TomSelect("#id_card", { create: false, sortField: { field: "text", direction: "asc" }});

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        const { data: persons } = await db.from('security_personnel_master').select('fullname').order('fullname');
        const selectPerson = document.getElementById('fullname');
        selectPerson.innerHTML = '<option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•...</option>';
        if (persons) {
            persons.forEach(p => {
                selectPerson.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`;
            });
        }
        new TomSelect("#fullname", { create: false, sortField: { field: "text", direction: "asc" }});

    } catch (err) {
        console.error("Load Master Error:", err);
    }
}

function handleRemarkChange() {
    const val = document.getElementById('remark_type').value;
    const otherDiv = document.getElementById('remark_other_div');
    if (val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        otherDiv.classList.remove('d-none');
        document.getElementById('remark_detail').focus();
    } else {
        otherDiv.classList.add('d-none');
        document.getElementById('remark_detail').value = '';
    }
}

// ================= FETCH HISTORY =================
async function fetchRecentHistory() {
    const listDiv = document.getElementById('historyList');
    try {
        // ‡∏î‡∏∂‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const { data, error } = await db.from('guard_attendance')
            .select('*').order('created_at', { ascending: false }).limit(5);
        if (error) throw error;

        listDiv.innerHTML = '';
        if (data.length === 0) {
            listDiv.innerHTML = `<div class="text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>`;
            return;
        }

        data.forEach(item => {
            const shiftIcon = item.shift.includes("‡πÄ‡∏ä‡πâ‡∏≤") ? "‚òÄÔ∏è" : "üåô";
            const timeIn = item.time_in ? `<span class="text-success fw-bold">IN: ${item.time_in}</span>` : '';
            const timeOut = item.time_out ? `<span class="text-danger fw-bold ms-2">OUT: ${item.time_out}</span>` : '';
            
            listDiv.innerHTML += `
                <div class="history-item animate__animated animate__fadeIn">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-primary">${item.fullname} <small class="text-muted">(${item.id_card})</small></div>
                        <small class="text-muted">${shiftIcon} ${item.work_date} | ${item.remark_type}</small>
                    </div>
                    <div class="text-end ms-2" style="font-size: 0.85rem;">
                        ${timeIn}<br>${timeOut}
                    </div>
                </div>
            `;
        });
    } catch (err) { console.error("History Error:", err); }
}

// ================= SUBMIT FORM =================
document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const time_in = document.getElementById('time_in').value || null;
    const time_out = document.getElementById('time_out').value || null;

    if(!time_in && !time_out) {
        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
        return;
    }

    const btn = document.getElementById('btnSubmit');
    const originalText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    const payload = {
        work_date: document.getElementById('work_date').value,
        shift: document.getElementById('shift').value,
        id_card: document.getElementById('id_card').value,  // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Dropdown ‡∏ö‡∏±‡∏ï‡∏£
        fullname: document.getElementById('fullname').value, // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Dropdown ‡∏ä‡∏∑‡πà‡∏≠
        time_in: time_in,
        time_out: time_out,
        remark_type: document.getElementById('remark_type').value,
        remark_detail: document.getElementById('remark_detail').value || null
    };

    try {
        const { error } = await db.from('guard_attendance').insert([payload]);
        if (error) throw error;

        await Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${payload.fullname} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, timer: 2000, showConfirmButton: false });
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('time_in').value = '';
        document.getElementById('time_out').value = '';
        document.getElementById('remark_type').value = '‡∏õ‡∏Å‡∏ï‡∏¥';
        handleRemarkChange();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        await fetchRecentHistory();

    } catch (err) { 
        Swal.fire('Error', err.message, 'error'); 
    } finally { 
        btn.disabled = false; 
        btn.innerHTML = originalText; 
    }
});
</script>

</body>
</html>