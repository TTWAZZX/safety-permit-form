<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†. (Smart Attendance)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .ts-control { padding: 12px; border-radius: 0.5rem; border-color: #d1d5db; font-size: 1rem; }
    </style>
</head>
<body class="text-gray-800 pb-10">

    <div class="bg-blue-800 text-white p-6 shadow-md rounded-b-3xl text-center">
        <h1 class="text-2xl font-bold">üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</h1>
        <p class="text-blue-200 text-sm mt-1">Smart Attendance System</p>
    </div>

    <div class="max-w-md mx-auto mt-6 px-4">
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <form id="attendanceForm" class="space-y-5">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Workaday)</label>
                    <input type="date" id="work_date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">üîÑ ‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Shift)</label>
                    <select id="shift" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô --</option>
                        <option value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (07:00-19:00)">‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (07:00-19:00)</option>
                        <option value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (19:00-07:00)">üåô ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (19:00-07:00)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">üÜî ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (ID Card)</label>
                    <select id="id_card" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠..."></select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                    <input type="text" id="fullname" readonly class="w-full p-3 border border-gray-200 bg-gray-100 rounded-lg text-gray-500 font-medium cursor-not-allowed">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">üü¢ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                        <input type="time" id="time_in" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">üî¥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                        <input type="time" id="time_out" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-1">* ‡∏´‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å" ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</p>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Remark)</label>
                    <select id="remark_type" onchange="handleRemarkChange()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="‡∏õ‡∏Å‡∏ï‡∏¥" selected>‚úÖ ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                        <option value="‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)">‚≠ê ‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)</option>
                        <option value="‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)">üîÑ ‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                    </select>
                </div>

                <div id="remark_other_div" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <input type="text" id="remark_detail" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition duration-200 mt-4 text-lg">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </form>
        </div>
    </div>

    <script>
        // üõë 1. ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á SUPABASE ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!
        const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let guardMap = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠

        // üìÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
        document.getElementById('work_date').valueAsDate = new Date();

        // üì• 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Master Data ‡∏à‡∏≤‡∏Å Supabase ‡∏°‡∏≤‡πÉ‡∏™‡πà Dropdown
        async function loadMasterData() {
            try {
                const { data, error } = await supabase.from('guard_master').select('*').order('id_card');
                if (error) throw error;

                const selectEl = document.getElementById('id_card');
                selectEl.innerHTML = '<option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠...</option>';

                data.forEach(g => {
                    guardMap[g.id_card] = g.fullname; // ‡∏à‡∏≥‡∏Ñ‡∏π‡πà‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
                    const opt = document.createElement('option');
                    opt.value = g.id_card;
                    opt.textContent = `${g.id_card} - ${g.fullname}`;
                    selectEl.appendChild(opt);
                });

                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TomSelect (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ)
                new TomSelect("#id_card", {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    onChange: function(selectedId) {
                        // üü¢ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        document.getElementById('fullname').value = guardMap[selectedId] || '';
                    }
                });
            } catch (err) {
                console.error("Load Master Error:", err);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏î‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠', 'error');
            }
        }

        // üîÑ 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
        function handleRemarkChange() {
            const val = document.getElementById('remark_type').value;
            const otherDiv = document.getElementById('remark_other_div');
            if (val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                otherDiv.classList.remove('hidden');
                document.getElementById('remark_detail').focus();
            } else {
                otherDiv.classList.add('hidden');
                document.getElementById('remark_detail').value = '';
            }
        }

        // üíæ 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const payload = {
                work_date: document.getElementById('work_date').value,
                shift: document.getElementById('shift').value,
                id_card: document.getElementById('id_card').value,
                fullname: document.getElementById('fullname').value,
                time_in: document.getElementById('time_in').value || null,
                time_out: document.getElementById('time_out').value || null,
                remark_type: document.getElementById('remark_type').value,
                remark_detail: document.getElementById('remark_detail').value || null
            };

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
            if(!payload.time_in && !payload.time_out) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏î‡∏¥‡πâ‡∏á
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á guard_attendance
                const { error } = await supabase.from('guard_attendance').insert([payload]);
                
                if (error) throw error;

                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${payload.fullname} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#2563eb'
                }).then(() => {
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
                    document.getElementById('time_in').value = '';
                    document.getElementById('time_out').value = '';
                    document.getElementById('remark_type').value = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    handleRemarkChange();
                });

            } catch (err) {
                console.error("Insert Error:", err);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        });

        // üöÄ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = loadMasterData;
    </script>
</body>
</html>