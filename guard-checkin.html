<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†. (Security Attendance)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ================= ENTERPRISE SECURITY THEME ================= */
        :root {
            --primary-color: #1e3a8a; /* Navy Blue */
            --secondary-color: #fbbf24; /* Security Gold */
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-color: #1e293b;
            --input-bg: #ffffff;
            --border-color: #cbd5e1;
            --success-color: #059669;
            --danger-color: #dc2626;
        }

        [data-theme="dark"] {
            --bg-color: #020617;
            --card-bg: rgba(15, 23, 42, 0.95);
            --text-color: #f8fafc;
            --input-bg: #1e293b;
            --border-color: #334155;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh; 
            padding-bottom: 30px; 
            transition: background-color 0.3s ease;
        }
        
        .container { max-width: 550px; padding: 0 15px; display: none; }

        /* ================= LOADING SCREEN ================= */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .security-spinner {
            font-size: 3rem; color: var(--primary-color);
            animation: pulse 1.5s infinite; margin-bottom: 15px;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* ================= MAIN APP UI ================= */
        .header-box {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0f172a 100%);
            color: white; padding: 30px 20px; border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 25px rgba(30, 58, 138, 0.2); text-align: center;
            position: relative; margin-bottom: -40px; z-index: 1;
        }
        
        .clock-display {
            font-size: 2.2rem; font-weight: 700; font-family: monospace; letter-spacing: 2px;
            color: var(--secondary-color); text-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
            margin-top: 5px;
        }

        .main-card {
            background: var(--card-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 20px; padding: 30px 20px 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.1);
            position: relative; z-index: 2; margin-top: 20px;
        }

        .form-label { font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem; }
        [data-theme="dark"] .form-label { color: #94a3b8; }

        .form-control, .form-select { 
            background-color: var(--input-bg); color: var(--text-color); 
            border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 15px; font-weight: 500;
        }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        .form-control[readonly] { background-color: rgba(0,0,0,0.02); }

        /* TomSelect Theme Fix */
        .ts-control { border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-color); padding: 12px 15px; }
        .ts-dropdown { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; font-size: 0.95rem; }
        .ts-dropdown .active { background-color: rgba(30, 58, 138, 0.1); color: var(--text-color); }

        /* Flatpickr Custom */
        .flatpickr-calendar { font-family: 'Sarabun', sans-serif; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: none; }

        .btn-submit { 
            background: var(--primary-color); color: white; width: 100%; 
            border-radius: 12px; padding: 15px; border: none; font-weight: 700; font-size: 1.1rem;
            transition: 0.3s; box-shadow: 0 8px 20px rgba(30, 58, 138, 0.25); margin-top: 15px;
        }
        .btn-submit:active { transform: scale(0.98); }

        /* ================= HISTORY LIST ================= */
        .history-title { font-size: 0.9rem; font-weight: 700; color: #64748b; text-transform: uppercase; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 35px; margin-bottom: 15px; }
        .history-item { 
            background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 12px; 
            border-left: 4px solid var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color);
        }
        .time-badge { background: #f1f5f9; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: 1px solid #e2e8f0; }
        [data-theme="dark"] .time-badge { background: #1e293b; border-color: #334155; }
    </style>
</head>
<body>

<div id="loadingScreen">
    <i class="bi bi-shield-check security-spinner"></i>
    <div class="fw-bold fs-5 text-uppercase tracking-wider" style="color: var(--primary-color);">Security System</div>
    <div class="text-muted small mt-1" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏∞‡∏ö‡∏ö...</div>
</div>

<div class="header-box animate__animated animate__fadeInDown">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <span class="badge bg-light text-dark bg-opacity-25 rounded-pill px-3 py-2 border border-light border-opacity-25">
                <i class="bi bi-person-circle me-1"></i> <span id="displayName">‡∏£‡∏õ‡∏†. ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</span>
            </span>
        </div>
        <button class="btn btn-link text-white p-0" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill fs-5" id="themeIcon"></i></button>
    </div>
    <div class="small opacity-75 text-uppercase tracking-wider mt-3">‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</div>
    <div class="clock-display" id="liveClock">00:00:00</div>
</div>

<div class="container animate__animated animate__fadeInUp" id="mainApp">
    <div class="main-card">
        <form id="attendanceForm">
            <input type="hidden" id="userId">

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label class="form-label"><i class="bi bi-calendar-date me-1"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="work_date" class="form-control bg-light" readonly>
                </div>
                <div class="col-6">
                    <label class="form-label"><i class="bi bi-clock-history me-1"></i> ‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                    <select id="shift" class="form-select" required>
                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞...</option>
                        <option value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (06:00-18:00)">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (06:00-18:00)</option>
                        <option value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (18:00-06:00)">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (18:00-06:00)</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-credit-card-2-front me-1"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (ID Card)</label>
                <select id="id_card" required placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£..."></select>
            </div>
            <div class="mb-3">
                <label class="form-label"><i class="bi bi-person-badge me-1"></i> ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <select id="fullname" required placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..."></select>
            </div>

            <div class="row g-3 mb-3 mt-1">
                <div class="col-6">
                    <label class="form-label text-success"><i class="bi bi-box-arrow-in-right me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="time_in" class="form-control fw-bold text-success time-picker" placeholder="--:-- ‡∏ô.">
                </div>
                <div class="col-6">
                    <label class="form-label text-danger"><i class="bi bi-box-arrow-right me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="time_out" class="form-control fw-bold text-danger time-picker" placeholder="--:-- ‡∏ô.">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-card-checklist me-1"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label>
                <select id="remark_type" class="form-select" onchange="handleRemarkChange()">
                    <option value="‡∏õ‡∏Å‡∏ï‡∏¥" selected>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                    <option value="‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                    <option value="‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)">‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)</option>
                    <option value="‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)">‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)</option>
                </select>
            </div>
            <div class="mb-4 d-none" id="remark_other_div">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                <input type="text" id="remark_detail" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
            </div>

            <button type="submit" id="btnSubmit" class="btn-submit">
                <i class="bi bi-shield-lock me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </form>
    </div>

    <div class="history-title"><i class="bi bi-list-columns-reverse me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    <div id="historyList">
        <div class="text-center text-muted small py-3"><i class="bi bi-arrow-clockwise animate-spin me-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</div>
    </div>
</div>

<script>
// ================= CONFIG =================
// üõë ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á Supabase ‡πÅ‡∏•‡∏∞ LIFF ID!
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const LIFF_ID = '2007053300-gJitj7Vr'; 

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö TomSelect Instance ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ set ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Memory
let selectCardInstance, selectPersonInstance;

// ================= INIT =================
window.onload = async () => {
    initTheme();
    startLiveClock();
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Date Picker ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    flatpickr("#work_date", { defaultDate: new Date(), dateFormat: "Y-m-d", locale: "th" });
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Time Picker (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ó‡πâ)
    flatpickr(".time-picker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, locale: "th" });

    try {
        // ‚ö° ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á Splash Screen ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 300ms 
        await updateLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö...", 300);
        
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        document.getElementById('displayName').innerText = profile.displayName;
        
        await updateLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", 300);

        await Promise.all([loadMasterData(), fetchRecentHistory()]);

        // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

    } catch (err) { 
        console.error('LIFF Error:', err);
        await Promise.all([loadMasterData(), fetchRecentHistory()]);
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    }
};

// ‚ö° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ
function updateLoader(text, delay) {
    return new Promise(resolve => {
        document.getElementById('loadStatusMain').innerText = text;
        setTimeout(resolve, delay);
    });
}

// ================= LIVE CLOCK =================
function startLiveClock() {
    setInterval(() => {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
    }, 1000);
}

// ================= THEME TOGGLE =================
function initTheme() {
    const savedTheme = localStorage.getItem('sec_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('sec_theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}

// ================= SMART MEMORY & DATA LOAD =================
async function loadMasterData() {
    try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£
        const { data: cards } = await db.from('security_card_master').select('card_number').order('card_number');
        const selectCard = document.getElementById('id_card');
        selectCard.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£...</option>';
        if (cards) cards.forEach(c => selectCard.innerHTML += `<option value="${c.card_number}">${c.card_number}</option>`);
        selectCardInstance = new TomSelect("#id_card", { create: false, sortField: { field: "text", direction: "asc" }});

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        const { data: persons } = await db.from('security_personnel_master').select('fullname').order('fullname');
        const selectPerson = document.getElementById('fullname');
        selectPerson.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•...</option>';
        if (persons) persons.forEach(p => selectPerson.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`);
        selectPersonInstance = new TomSelect("#fullname", { create: false, sortField: { field: "text", direction: "asc" }});

        // üß† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Smart Memory)
        const savedCard = localStorage.getItem('sec_last_card');
        const savedName = localStorage.getItem('sec_last_name');
        const savedShift = localStorage.getItem('sec_last_shift');

        if(savedCard) selectCardInstance.setValue(savedCard);
        if(savedName) selectPersonInstance.setValue(savedName);
        if(savedShift) document.getElementById('shift').value = savedShift;

    } catch (err) { console.error("Load Master Error:", err); }
}

function handleRemarkChange() {
    const val = document.getElementById('remark_type').value;
    const otherDiv = document.getElementById('remark_other_div');
    if (val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        otherDiv.classList.remove('d-none');
        document.getElementById('remark_detail').focus();
    } else {
        otherDiv.classList.add('d-none');
        document.getElementById('remark_detail').value = '';
    }
}

// ================= FETCH HISTORY =================
async function fetchRecentHistory() {
    const listDiv = document.getElementById('historyList');
    try {
        const { data, error } = await db.from('guard_attendance').select('*').order('created_at', { ascending: false }).limit(5);
        if (error) throw error;

        listDiv.innerHTML = '';
        if (data.length === 0) {
            listDiv.innerHTML = `<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>`;
            return;
        }

        data.forEach(item => {
            const shiftText = item.shift.split(' ')[0];
            const timeIn = item.time_in ? `<span class="text-success"><i class="bi bi-box-arrow-in-right"></i> ${item.time_in}</span>` : '';
            const timeOut = item.time_out ? `<span class="text-danger ms-2"><i class="bi bi-box-arrow-right"></i> ${item.time_out}</span>` : '';
            
            listDiv.innerHTML += `
                <div class="history-item animate__animated animate__fadeIn">
                    <div class="flex-grow-1">
                        <div class="fw-bold" style="color: var(--primary-color);">${item.fullname} <span class="text-muted small">(${item.id_card})</span></div>
                        <div class="text-muted small mt-1"><i class="bi bi-clock"></i> ${shiftText} | ${item.remark_type}</div>
                    </div>
                    <div class="text-end">
                        <div class="time-badge">${timeIn} ${timeOut}</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 3px;">${item.work_date}</div>
                    </div>
                </div>
            `;
        });
    } catch (err) { console.error("History Error:", err); }
}

// ================= SUBMIT FORM =================
document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const time_in = document.getElementById('time_in').value || null;
    const time_out = document.getElementById('time_out').value || null;

    if(!time_in && !time_out) {
        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á', confirmButtonColor: '#1e3a8a' });
        return;
    }

    const btn = document.getElementById('btnSubmit');
    const originalText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    const payload = {
        work_date: document.getElementById('work_date').value,
        shift: document.getElementById('shift').value,
        id_card: document.getElementById('id_card').value,
        fullname: document.getElementById('fullname').value,
        time_in: time_in,
        time_out: time_out,
        remark_type: document.getElementById('remark_type').value,
        remark_detail: document.getElementById('remark_detail').value || null
    };

    try {
        const { error } = await db.from('guard_attendance').insert([payload]);
        if (error) throw error;

        // üß† ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Memory ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        localStorage.setItem('sec_last_card', payload.id_card);
        localStorage.setItem('sec_last_name', payload.fullname);
        localStorage.setItem('sec_last_shift', payload.shift);

        // Haptic Feedback (‡∏™‡∏±‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
        if (navigator.vibrate) navigator.vibrate(50);

        await Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ${payload.fullname} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, timer: 2000, showConfirmButton: false });
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        document.getElementById('time_in').value = '';
        document.getElementById('time_out').value = '';
        document.getElementById('remark_type').value = '‡∏õ‡∏Å‡∏ï‡∏¥';
        handleRemarkChange();
        
        await fetchRecentHistory();

    } catch (err) { 
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message, confirmButtonColor: '#1e3a8a' }); 
    } finally { 
        btn.disabled = false; btn.innerHTML = originalText; 
    }
});
</script>

</body>
</html>