<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†. - Thai Summit Harness</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ================= CORPORATE SECURITY THEME ================= */
        :root {
            --primary-color: #0f2027; 
            --secondary-color: #203a43;
            --accent-color: #d4af37; 
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --border-color: #dee2e6;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #f8f9fa;
            --border-color: #343a40;
        }

        /* üì± ‡∏õ‡∏£‡∏±‡∏ö padding-bottom ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 90px; transition: 0.3s; }
        .container { max-width: 500px; padding: 0 15px; display: none; }

        /* ================= LOADING SCREEN ================= */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner-border { color: var(--accent-color); width: 3rem; height: 3rem; margin-bottom: 15px; }

        /* ================= HEADER & PROFILE ================= */
        .profile-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 30px 20px; border-radius: 0 0 30px 30px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative; }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--accent-color); object-fit: cover; background: white; padding: 2px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .theme-toggle { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 50%; width: 35px; height: 35px; }

        /* ================= INFO CARDS ================= */
        .info-card { background: var(--card-bg); border-radius: 16px; padding: 15px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-top: -20px; position: relative; z-index: 2; }
        .clock-display { font-size: 2.5rem; font-weight: 700; font-family: monospace; color: var(--accent-color); letter-spacing: 2px; line-height: 1; margin-top: 5px; }

        .main-card { background: var(--card-bg); border-radius: 20px; padding: 25px 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-top: 15px; }

        .form-label { font-size: 0.85rem; font-weight: 700; color: #6c757d; text-transform: uppercase; }
        .form-control, .form-select { border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); padding: 12px; font-weight: 500; }
        .form-control:focus, .form-select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
        .form-control[readonly] { background-color: rgba(0,0,0,0.03); }

        /* TomSelect Theme */
        .ts-control { border-radius: 10px; padding: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); }
        .ts-dropdown { border-radius: 10px; background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); }
        .ts-dropdown .active { background-color: rgba(212, 175, 55, 0.1); color: var(--text-main); }

        .btn-submit { background: var(--primary-color); color: white; width: 100%; border-radius: 12px; padding: 15px; font-weight: 700; font-size: 1.1rem; border: none; box-shadow: 0 6px 15px rgba(15, 32, 39, 0.3); transition: 0.2s; }
        .btn-submit:active { transform: scale(0.98); }

        /* ================= HISTORY ================= */
        .history-item { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent-color); border-right: 1px solid var(--border-color); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .action-btn { background: none; border: none; color: #6c757d; font-size: 1.1rem; padding: 5px; transition: 0.2s; }
        .action-btn:hover { color: var(--primary-color); transform: scale(1.1); }
        .action-btn.delete:hover { color: #dc3545; }

        /* ================= üì± BOTTOM NAVIGATION (App Style) ================= */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000;
            display: flex; justify-content: space-around; padding: 10px 0 15px;
            padding-bottom: env(safe-area-inset-bottom); /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }
        .bottom-nav .nav-item {
            text-align: center; color: #6c757d; text-decoration: none;
            font-size: 0.85rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; transition: 0.2s; width: 50%;
        }
        .bottom-nav .nav-item i { font-size: 1.6rem; margin-bottom: 2px; }
        .bottom-nav .nav-item.active { color: var(--accent-color); }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="spinner-border" role="status"></div>
    <div class="fw-bold fs-5" style="color: var(--primary-color);"><i class="bi bi-shield-lock-fill me-2"></i>Security System</div>
    <div class="text-muted small mt-2" id="loadStatusMain">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="profile-header animate__animated animate__fadeInDown">
    <button class="theme-toggle" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i></button>
    <img id="profileImage" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="profile-img mb-3">
    <h5 id="displayName" class="fw-bold mb-1">‡∏£‡∏õ‡∏†. ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</h5>
    <span class="badge bg-light text-dark bg-opacity-75"><i class="bi bi-person-badge-fill me-1"></i> ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
</div>

<div class="container" id="mainApp">
    
    <div class="info-card mx-3">
        <div class="small fw-bold text-muted text-uppercase"><i class="bi bi-geo-alt-fill text-danger me-1"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
        <div class="fw-bold" style="color: var(--primary-color); font-size: 1.1rem;">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏ã‡∏±‡∏°‡∏°‡∏¥‡∏ó ‡∏Æ‡∏≤‡∏£‡πå‡πÄ‡∏ô‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏°‡∏´‡∏≤‡∏ä‡∏ô)</div>
        <hr class="my-2 opacity-25">
        <div class="small fw-bold text-muted text-uppercase"><i class="bi bi-clock-fill text-primary me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÑ‡∏ó‡∏¢)</div>
        <div class="clock-display" id="liveClock">00:00:00</div>
    </div>

    <div id="formPage" class="page-section active">
        <div class="main-card">
            <form id="attendanceForm">
                <input type="hidden" id="picUrl">

                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-calendar-event me-1"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                        <input type="date" id="work_date" class="form-control" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label"><i class="bi bi-arrow-repeat me-1"></i> ‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                        <select id="shift" class="form-select" required>
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏∞...</option>
                            <option value="‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (06:00-18:00)">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (06:00-18:00)</option>
                            <option value="‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (18:00-06:00)">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (18:00-06:00)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-upc-scan me-1"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                    <select id="id_card" required placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£..."></select>
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-person-vcard me-1"></i> ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label>
                    <select id="fullname" required placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•..."></select>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label text-success"><i class="bi bi-box-arrow-in-right me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label>
                        <input type="text" id="time_in" class="form-control fw-bold text-success fs-5 text-center" placeholder="08:00" inputmode="numeric" pattern="[0-9]*" maxlength="5" oninput="formatTime(this)">
                    </div>
                    <div class="col-6">
                        <label class="form-label text-danger"><i class="bi bi-box-arrow-right me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                        <input type="text" id="time_out" class="form-control fw-bold text-danger fs-5 text-center" placeholder="17:00" inputmode="numeric" pattern="[0-9]*" maxlength="5" oninput="formatTime(this)">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-journal-text me-1"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label>
                    <select id="remark_type" class="form-select" onchange="handleRemarkChange()">
                        <option value="‡∏õ‡∏Å‡∏ï‡∏¥" selected>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‡∏Ñ‡∏ß‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                        <option value="‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)">‡πÅ‡∏ó‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î ‡∏£‡∏õ‡∏†.)</option>
                        <option value="‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)">‡πÅ‡∏ó‡∏ô (‡∏£‡∏õ‡∏†.)</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)</option>
                    </select>
                </div>
                
                <div class="mb-4 d-none" id="remark_substitute_div">
                    <label class="form-label text-warning"><i class="bi bi-people-fill me-1"></i> ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏î?</label>
                    <select id="remark_substitute" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô..."></select>
                </div>

                <div class="mb-4 d-none" id="remark_other_div">
                    <label class="form-label text-warning"><i class="bi bi-pencil-square me-1"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <input type="text" id="remark_detail" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">
                </div>

                <button type="submit" id="btnSubmit" class="btn-submit mt-2">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>
    </div>

    <div id="historyPage" class="page-section pt-3">
        <h5 class="fw-bold mb-3" style="color: var(--primary-color);"><i class="bi bi-clock-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h5>
        
        <ul class="nav nav-pills nav-fill mb-3" id="historyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-today-btn" data-bs-toggle="pill" data-bs-target="#tab-today" type="button">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-past-btn" data-bs-toggle="pill" data-bs-target="#tab-past" type="button">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
            </li>
        </ul>
        <div class="tab-content" id="historyTabsContent">
            <div class="tab-pane fade show active" id="tab-today">
                <div id="listToday"><div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
            </div>
            <div class="tab-pane fade" id="tab-past">
                <div id="listPast"><div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
            </div>
        </div>
    </div>

</div>

<nav class="bottom-nav no-print">
    <a href="#" class="nav-item active" id="nav-form" onclick="switchPage('form')">
        <i class="bi bi-shield-check"></i>
        <span>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
    </a>
    <a href="#" class="nav-item" id="nav-history" onclick="switchPage('history')">
        <i class="bi bi-card-list"></i>
        <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
    </a>
</nav>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';
const LIFF_ID = '2007053300-gJitj7Vr';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let selectCardInstance, selectPersonInstance, selectSubstituteInstance;

// ================= INIT =================
window.onload = async () => {
    initTheme();
    startLiveClock();
    document.getElementById('work_date').valueAsDate = new Date();

    try {
        await updateLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...", 300);
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        document.getElementById('displayName').innerText = profile.displayName;
        if(profile.pictureUrl) {
            document.getElementById('profileImage').src = profile.pictureUrl;
            document.getElementById('picUrl').value = profile.pictureUrl;
        }

        await updateLoader("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö...", 200);
        await Promise.all([loadMasterData(), fetchHistory()]);

        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

    } catch (err) { 
        console.error('LIFF Error:', err);
        await Promise.all([loadMasterData(), fetchHistory()]);
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    }
};

function updateLoader(text, delay) { return new Promise(r => { document.getElementById('loadStatusMain').innerText = text; setTimeout(r, delay); }); }

// ================= üì± APP NAVIGATION =================
function switchPage(page) {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î Active ‡∏≠‡∏≠‡∏Å
    document.getElementById('formPage').classList.remove('active');
    document.getElementById('historyPage').classList.remove('active');
    document.getElementById('nav-form').classList.remove('active');
    document.getElementById('nav-history').classList.remove('active');

    // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if(page === 'form') {
        document.getElementById('formPage').classList.add('active');
        document.getElementById('nav-form').classList.add('active');
    } else {
        document.getElementById('historyPage').classList.add('active');
        document.getElementById('nav-history').classList.add('active');
        fetchHistory(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π
    }
}

// ================= CLOCK & THEME =================
function startLiveClock() { setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('th-TH', { hour12: false }); }, 1000); }
function initTheme() {
    const savedTheme = localStorage.getItem('sec_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('sec_theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}

// ================= LOAD DATA & MEMORY =================
async function loadMasterData() {
    try {
        const { data: cards } = await db.from('security_card_master').select('card_number').order('card_number');
        const selectCard = document.getElementById('id_card');
        selectCard.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£...</option>';
        if (cards) cards.forEach(c => selectCard.innerHTML += `<option value="${c.card_number}">${c.card_number}</option>`);
        selectCardInstance = new TomSelect("#id_card", { create: false, sortField: { field: "text", direction: "asc" }});

        const { data: persons } = await db.from('security_personnel_master').select('fullname').order('fullname');
        const selectPerson = document.getElementById('fullname');
        const selectSub = document.getElementById('remark_substitute'); // ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô
        selectPerson.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•...</option>';
        selectSub.innerHTML = '<option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô...</option>';
        
        if (persons) {
            persons.forEach(p => {
                selectPerson.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`;
                selectSub.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`;
            });
        }
        selectPersonInstance = new TomSelect("#fullname", { create: false, sortField: { field: "text", direction: "asc" }});
        selectSubstituteInstance = new TomSelect("#remark_substitute", { create: false, sortField: { field: "text", direction: "asc" }});

        // Memory
        if(localStorage.getItem('sec_last_card')) selectCardInstance.setValue(localStorage.getItem('sec_last_card'));
        if(localStorage.getItem('sec_last_name')) selectPersonInstance.setValue(localStorage.getItem('sec_last_name'));
        if(localStorage.getItem('sec_last_shift')) document.getElementById('shift').value = localStorage.getItem('sec_last_shift');
    } catch (err) { console.error("Load Master Error:", err); }
}

// ================= ‚è∞ CUSTOM TIME FORMATTER (Numpad) =================
function formatTime(input) {
    let val = input.value.replace(/\D/g, ''); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
    if (val.length > 2) {
        val = val.substring(0, 2) + ':' + val.substring(2, 4); // ‡πÄ‡∏ï‡∏¥‡∏° : ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    }
    input.value = val;
}
function validateTimeStr(timeStr) {
    if (!timeStr) return true;
    if (timeStr.length !== 5) return false;
    const [h, m] = timeStr.split(':');
    if (parseInt(h) > 23 || parseInt(m) > 59) return false;
    return true;
}

// ================= üìù REMARK LOGIC =================
function handleRemarkChange() {
    const val = document.getElementById('remark_type').value;
    const subDiv = document.getElementById('remark_substitute_div');
    const otherDiv = document.getElementById('remark_other_div');

    subDiv.classList.add('d-none');
    otherDiv.classList.add('d-none');
    document.getElementById('remark_detail').value = '';
    selectSubstituteInstance.clear();

    if (val.includes('‡πÅ‡∏ó‡∏ô')) {
        subDiv.classList.remove('d-none'); // ‡πÇ‡∏ä‡∏ß‡πå Dropdown ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô
    } else if (val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        otherDiv.classList.remove('d-none'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
        document.getElementById('remark_detail').focus();
    }
}

// ================= HISTORY =================
async function fetchHistory() {
    try {
        const todayStr = new Date().toISOString().split('T')[0];
        const nameFilter = localStorage.getItem('sec_last_name'); 
        
        let query = db.from('guard_attendance').select('*').order('created_at', { ascending: false }).limit(20);
        if(nameFilter) query = query.eq('fullname', nameFilter);

        const { data, error } = await query;
        if (error) throw error;

        let htmlToday = '', htmlPast = '';
        
        data.forEach(item => {
            const isToday = item.work_date === todayStr;
            const shiftText = item.shift.split(' ')[0];
            const timeIn = item.time_in ? `<span class="text-success fw-bold">IN: ${item.time_in}</span>` : '-';
            const timeOut = item.time_out ? `<span class="text-danger fw-bold ms-2">OUT: ${item.time_out}</span>` : '';
            
            const actionBtns = `
                <div class="mt-2 text-end border-top pt-2">
                    <button type="button" class="action-btn" onclick="userEdit('${item.id}', '${item.id_card}', '${item.time_in||''}', '${item.time_out||''}')"><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button type="button" class="action-btn delete ms-2" onclick="userDelete('${item.id}', '${item.id_card}')"><i class="bi bi-trash"></i> ‡∏•‡∏ö</button>
                </div>
            `;

            const card = `
                <div class="history-item animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold" style="color: var(--primary-color);">${item.work_date}</div>
                        <div class="badge bg-secondary bg-opacity-10 text-dark border">${shiftText}</div>
                    </div>
                    <div class="small text-muted mb-2"><i class="bi bi-person-vcard"></i> ${item.id_card} | ${item.remark_type} ${item.remark_detail ? `(${item.remark_detail})` : ''}</div>
                    <div class="bg-light p-2 rounded text-center border" style="font-size: 0.9rem;">
                        ${timeIn} ${timeOut}
                    </div>
                    ${actionBtns}
                </div>
            `;
            if(isToday) htmlToday += card; else htmlPast += card;
        });

        document.getElementById('listToday').innerHTML = htmlToday || '<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        document.getElementById('listPast').innerHTML = htmlPast || '<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>';

    } catch (err) { console.error(err); }
}

// ================= USER EDIT/DELETE =================
async function verifyUser(id_card) {
    const { value: confirmId } = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        input: 'text', inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô G-001',
        showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        inputValidator: (value) => { if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£!' }
    });
    return confirmId === id_card;
}

async function userEdit(id, id_card, currentIn, currentOut) {
    if(!(await verifyUser(id_card))) return Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 'error');

    const { value: formValues } = await Swal.fire({
        title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤',
        html: `
            <div class="text-start mt-3">
                <label class="form-label text-success">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label>
                <input type="text" id="swal-in" value="${currentIn}" class="form-control mb-3 text-center" inputmode="numeric" placeholder="08:00" maxlength="5" oninput="formatTime(this)">
                <label class="form-label text-danger">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                <input type="text" id="swal-out" value="${currentOut}" class="form-control text-center" inputmode="numeric" placeholder="17:00" maxlength="5" oninput="formatTime(this)">
            </div>
        `,
        focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        preConfirm: () => { 
            const tin = document.getElementById('swal-in').value;
            const tout = document.getElementById('swal-out').value;
            if((tin && !validateTimeStr(tin)) || (tout && !validateTimeStr(tout))) { Swal.showValidationMessage('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (00:00 - 23:59)'); return false; }
            return { in: tin, out: tout };
        }
    });

    if (formValues) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
        const { error } = await db.from('guard_attendance').update({
            time_in: formValues.in || null, time_out: formValues.out || null,
            updated_at: new Date(), updated_by: 'User (‡∏£‡∏õ‡∏†.)'
        }).eq('id', id);

        if (error) Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
        else { Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false }); fetchHistory(); }
    }
}

async function userDelete(id, id_card) {
    if(!(await verifyUser(id_card))) return Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 'error');
    const res = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á' });
    if(res.isConfirmed) {
        await db.from('guard_attendance').delete().eq('id', id);
        Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false }); fetchHistory();
    }
}

// ================= SUBMIT FORM =================
document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const time_in = document.getElementById('time_in').value || null;
    const time_out = document.getElementById('time_out').value || null;

    if(!time_in && !time_out) return Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á' });
    if((time_in && !validateTimeStr(time_in)) || (time_out && !validateTimeStr(time_out))) {
        return Swal.fire({ icon: 'error', title: '‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (00:00 - 23:59)' });
    }

    const remark_type = document.getElementById('remark_type').value;
    let final_remark_detail = null;

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (remark_type.includes('‡πÅ‡∏ó‡∏ô')) {
        final_remark_detail = document.getElementById('remark_substitute').value;
        if(!final_remark_detail) return Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô' });
    } else if (remark_type === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        final_remark_detail = document.getElementById('remark_detail').value;
    }

    const btn = document.getElementById('btnSubmit');
    const originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="width:1.2rem;height:1.2rem;color:white;"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    const payload = {
        work_date: document.getElementById('work_date').value,
        shift: document.getElementById('shift').value,
        id_card: document.getElementById('id_card').value,
        fullname: document.getElementById('fullname').value,
        time_in: time_in,
        time_out: time_out,
        remark_type: remark_type,
        remark_detail: final_remark_detail,
        profile_pic: document.getElementById('picUrl').value || null
    };

    try {
        const { error } = await db.from('guard_attendance').insert([payload]);
        if (error) throw error;

        localStorage.setItem('sec_last_card', payload.id_card);
        localStorage.setItem('sec_last_name', payload.fullname);
        localStorage.setItem('sec_last_shift', payload.shift);
        if (navigator.vibrate) navigator.vibrate(50);

        await Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
        
        document.getElementById('time_in').value = ''; document.getElementById('time_out').value = '';
        document.getElementById('remark_type').value = '‡∏õ‡∏Å‡∏ï‡∏¥'; handleRemarkChange();
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        switchPage('history');

    } catch (err) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error'); } 
    finally { btn.disabled = false; btn.innerHTML = originalText; }
});
</script>
</body>
</html>