<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏ó‡πå‡πÄ‡∏õ‡πá‡∏ô PDF */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            .print-table { width: 100%; border-collapse: collapse; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 4px; font-size: 12px; }
        }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-900 text-white p-4 shadow-md no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">üõ°Ô∏è Security Admin Dashboard</h1>
            <div class="space-x-4">
                <button onclick="switchTab('attendance')" class="hover:text-blue-300 font-semibold">üïí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
                <button onclick="switchTab('master')" class="hover:text-blue-300 font-semibold">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏õ‡∏†.</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto mt-8 px-4">
        
        <div id="tab-attendance" class="block">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-wrap justify-between items-end mb-6 no-print gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                        <div class="flex space-x-2">
                            <input type="month" id="filterMonth" class="p-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="loadAttendance()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow font-semibold">üìä ‡πÇ‡∏´‡∏•‡∏î Excel</button>
                        <button onclick="exportPDF()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 shadow font-semibold">üìÑ ‡πÇ‡∏´‡∏•‡∏î PDF</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table id="attendanceTable" class="w-full text-left border-collapse print-table">
                        <thead>
                            <tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal border-b">
                                <th class="py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-3 px-4">‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                <th class="py-3 px-4">‡∏£‡∏´‡∏±‡∏™-‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th class="py-3 px-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th>
                                <th class="py-3 px-4 text-center">‡∏≠‡∏≠‡∏Å (OUT)</th>
                                <th class="py-3 px-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th class="py-3 px-4 text-center no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTbody" class="text-sm font-light">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-master" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md h-fit">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏õ‡∏†. ‡πÉ‡∏´‡∏°‡πà</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (ID)</label>
                            <input type="text" id="new_id_card" placeholder="‡πÄ‡∏ä‡πà‡∏ô G-004" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="new_fullname" placeholder="‡∏ô‡∏≤‡∏¢..." class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button onclick="addGuard()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>

                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">üìã ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏õ‡∏†. (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 text-sm border-b">
                                    <th class="py-2 px-4">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                                    <th class="py-2 px-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="py-2 px-4 text-center">‡∏•‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody id="masterTbody" class="text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // üõë ‡πÉ‡∏™‡πà KEY ‡∏Ç‡∏≠‡∏á SUPABASE ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
        const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const today = new Date();
        document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        window.onload = () => {
            loadAttendance();
            loadMasterData();
        };

        // üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡πá‡∏ö
        function switchTab(tabName) {
            document.getElementById('tab-attendance').classList.add('hidden');
            document.getElementById('tab-master').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        }

        // ==========================================
        // üïí ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Attendance)
        // ==========================================
        async function loadAttendance() {
            const filterMonth = document.getElementById('filterMonth').value; // YYYY-MM
            let query = supabase.from('guard_attendance').select('*').order('work_date', { ascending: false }).order('created_at', { ascending: false });
            
            if (filterMonth) {
                const startDate = `${filterMonth}-01`;
                const endDate = `${filterMonth}-31`; // Supabase ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
                query = query.gte('work_date', startDate).lte('work_date', endDate);
            }

            const { data, error } = await query;
            if (error) return console.error(error);

            const tbody = document.getElementById('attendanceTbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                let remarkHtml = row.remark_type;
                if(row.remark_type !== '‡∏õ‡∏Å‡∏ï‡∏¥') {
                    remarkHtml = `<span class="text-red-600 font-semibold">${row.remark_type}</span>`;
                    if(row.remark_detail) remarkHtml += `<br><span class="text-xs text-gray-500">${row.remark_detail}</span>`;
                }

                tr.innerHTML = `
                    <td class="py-3 px-4 font-medium">${row.work_date}</td>
                    <td class="py-3 px-4 text-gray-600">${row.shift}</td>
                    <td class="py-3 px-4"><span class="font-bold text-gray-800">${row.id_card}</span><br><span class="text-xs text-gray-500">${row.fullname}</span></td>
                    <td class="py-3 px-4 text-center font-bold text-green-600">${row.time_in || '-'}</td>
                    <td class="py-3 px-4 text-center font-bold text-red-500">${row.time_out || '-'}</td>
                    <td class="py-3 px-4">${remarkHtml}</td>
                    <td class="py-3 px-4 text-center no-print">
                        <button onclick="editTime('${row.id}', '${row.time_in || ''}', '${row.time_out || ''}')" class="text-blue-500 hover:text-blue-700 bg-blue-100 p-2 rounded-lg text-xs font-bold">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ‚úèÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤
        async function editTime(id, currentIn, currentOut) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å',
                html: `
                    <div class="text-left mt-4">
                        <label class="block text-sm font-semibold mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                        <input id="swal-in" type="time" value="${currentIn}" class="w-full p-2 border rounded mb-3">
                        <label class="block text-sm font-semibold mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                        <input id="swal-out" type="time" value="${currentOut}" class="w-full p-2 border rounded">
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    return {
                        in: document.getElementById('swal-in').value,
                        out: document.getElementById('swal-out').value
                    }
                }
            });

            if (formValues) {
                const { error } = await supabase.from('guard_attendance').update({
                    time_in: formValues.in || null,
                    time_out: formValues.out || null,
                    updated_at: new Date()
                }).eq('id', id);

                if (error) {
                    Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
                } else {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    loadAttendance(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                }
            }
        }

        // ==========================================
        // üë• ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Master Data)
        // ==========================================
        async function loadMasterData() {
            const { data, error } = await supabase.from('guard_master').select('*').order('id_card');
            if (error) return console.error(error);

            const tbody = document.getElementById('masterTbody');
            tbody.innerHTML = '';

            data.forEach(guard => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-2 px-4 font-bold text-gray-800">${guard.id_card}</td>
                    <td class="py-2 px-4">${guard.fullname}</td>
                    <td class="py-2 px-4 text-center">
                        <button onclick="deleteGuard('${guard.id}', '${guard.fullname}')" class="text-red-500 hover:text-red-700 font-bold">üóëÔ∏è ‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function addGuard() {
            const id_card = document.getElementById('new_id_card').value.trim();
            const fullname = document.getElementById('new_fullname').value.trim();

            if(!id_card || !fullname) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

            const { error } = await supabase.from('guard_master').insert([{ id_card, fullname }]);
            
            if (error) {
                if (error.code === '23505') Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', 'error');
                else Swal.fire('Error', error.message, 'error');
            } else {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                document.getElementById('new_id_card').value = '';
                document.getElementById('new_fullname').value = '';
                loadMasterData();
            }
        }

        async function deleteGuard(id, name) {
            Swal.fire({
                title: `‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ${name}?`,
                text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á ‡∏£‡∏õ‡∏†. ‡∏≠‡∏µ‡∏Å",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabase.from('guard_master').delete().eq('id', id);
                    Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '', 'success');
                    loadMasterData();
                }
            });
        }

        // ==========================================
        // üìä ‡∏£‡∏∞‡∏ö‡∏ö Export Data (Excel & PDF)
        // ==========================================
        function exportExcel() {
            const month = document.getElementById('filterMonth').value;
            // ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML ‡∏°‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Excel (‡πÉ‡∏ä‡πâ SheetJS)
            let table = document.getElementById("attendanceTable");
            let wb = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
            XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤_‡∏£‡∏õ‡∏†_${month || 'All'}.xlsx`);
        }

        function exportPDF() {
            // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Print ‡∏Ç‡∏≠‡∏á Browser (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 100% ‡∏™‡∏£‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°)
            window.print();
        }
    </script>
</body>
</html>