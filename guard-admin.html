<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enterprise Admin - ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ================= THEME VARIABLES (Super App) ================= */
        :root {
            --primary-color: #0ea5e9;
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #334155;
            --input-bg: #fff;
            --border-color: #e2e8f0;
            --table-hover: rgba(14, 165, 233, 0.05);
            --table-header: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --text-color: #f1f5f9;
            --input-bg: #1e293b;
            --border-color: #334155;
            --table-hover: rgba(255, 255, 255, 0.05);
            --table-header: rgba(0, 0, 0, 0.2);
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh; 
            padding-bottom: 30px; 
            transition: background-color 0.3s ease;
        }

        /* ================= LOADING SCREEN ================= */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .line-spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .loading-text-main { font-weight: bold; font-size: 1.2rem; color: var(--text-color); margin-bottom: 5px; }

        /* ================= MAIN LAYOUT & GLASS CARDS ================= */
        .admin-card {
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .top-navbar {
            background: linear-gradient(135deg, #0ea5e9 0%, #1e3a8a 100%);
            padding: 15px 20px; color: white; border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.2); margin-bottom: 30px;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.2); color: white;
            border: none; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }

        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border-color: var(--border-color); border-radius: 10px; }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-color); border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(14, 165, 233, 0.25); }
        
        .table { color: var(--text-color); border-color: var(--border-color); vertical-align: middle; }
        .table thead th { background-color: var(--table-header); color: var(--text-color); border-bottom: 2px solid var(--border-color); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        .table tbody tr:hover { background-color: var(--table-hover); }
        .table td { border-color: var(--border-color); }
        
        .nav-pills .nav-link { color: var(--text-color); font-weight: 600; border-radius: 12px; padding: 10px 20px; margin-right: 10px; transition: 0.3s; border: 1px solid transparent; }
        .nav-pills .nav-link:hover { background-color: rgba(14, 165, 233, 0.1); }
        .nav-pills .nav-link.active { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }

        .btn-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; font-weight: 600; transition: 0.3s; }
        .btn-gradient:hover { box-shadow: 0 5px 15px rgba(14, 165, 233, 0.4); color: white; transform: translateY(-2px); }

        /* ================= PRINT TEMPLATE (PDF ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£) ================= */
        .print-only { display: none; }
        
        @media print {
            @page { size: A4 portrait; margin: 15mm; }
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: black !important; padding: 0; }
            .no-print { display: none !important; }
            .admin-card { box-shadow: none !important; border: none !important; padding: 0 !important; background: transparent !important; }
            
            .print-only { display: block; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            .print-header h3 { font-weight: bold; font-size: 18pt; margin-bottom: 5px; color: black; }
            .print-header p { font-size: 12pt; margin: 0; color: black; }
            
            .table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #000 !important; }
            .table th, .table td { border: 1px solid #000 !important; padding: 8px !important; font-size: 11pt !important; color: #000 !important; }
            .table th { background-color: #f0f0f0 !important; font-weight: bold; text-align: center; }
            
            .print-footer { display: flex; justify-content: space-around; margin-top: 50px; page-break-inside: avoid; }
            .sign-box { text-align: center; width: 200px; color: black; }
            .sign-line { border-bottom: 1px dashed #000; margin-bottom: 10px; height: 30px; }
        }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="line-spinner"></div>
    <div class="loading-text-main" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="top-navbar no-print">
    <div class="container-xl d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="bi bi-shield-lock-fill fs-2 me-3"></i>
            <div>
                <h4 class="mb-0 fw-bold">Security Admin</h4>
                <small class="opacity-75">Enterprise Dashboard</small>
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill fs-5" id="themeIcon"></i></button>
    </div>
</div>

<div class="container-xl" style="display: none;" id="mainApp">
    
    <ul class="nav nav-pills mb-4 no-print" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-attendance" type="button"><i class="bi bi-clock-history me-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-master" type="button"><i class="bi bi-database-fill-gear me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ï‡∏£/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-attendance">
            
            <div class="print-only print-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏£‡∏õ‡∏†.)</h3>
                <p>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <span id="print-month-label" class="fw-bold">-</span> | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="print-name-label" class="fw-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></p>
                <p style="font-size: 10pt; text-align: right; margin-top: 5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="print-date"></span></p>
            </div>

            <div class="admin-card mb-4 no-print animate__animated animate__fadeIn">
                <div class="row align-items-end g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <input type="month" id="filterMonth" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                        <select id="filterName" class="form-select">
                            <option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
                            </select>
                    </div>
                    <div class="col-md-2">
                        <button onclick="loadAttendance()" class="btn btn-gradient w-100 fw-bold rounded-3"><i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <div class="col-md-3 text-end">
                        <button onclick="exportExcel()" class="btn btn-success fw-bold me-2 rounded-3"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button onclick="exportPDF()" class="btn btn-danger fw-bold rounded-3"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                    </div>
                </div>
            </div>

            <div class="admin-card animate__animated animate__fadeIn">
                <div class="table-responsive">
                    <table id="attendanceTable" class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                <th class="text-center">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th>
                                <th class="text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th class="text-center no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="print-only print-footer">
                <div class="sign-box"><div class="sign-line"></div><p>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p></div>
                <div class="sign-box"><div class="sign-line"></div><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏à‡∏õ./‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-master">
            <div class="row g-4 no-print">
                <div class="col-md-6">
                    <div class="admin-card h-100 animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-4 text-primary"><i class="bi bi-credit-card-2-front me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (ID Cards)</h5>
                        <div class="d-flex gap-2 mb-3">
                            <input type="text" id="new_card" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô G-001">
                            <button onclick="addMaster('card')" class="btn btn-primary fw-bold px-4 rounded-3">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th class="text-end">‡∏•‡∏ö</th></tr></thead>
                                <tbody id="cardTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="admin-card h-100 animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-4 text-success"><i class="bi bi-person-badge me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Personnel)</h5>
                        <div class="d-flex gap-2 mb-3">
                            <input type="text" id="new_person" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <button onclick="addMaster('person')" class="btn btn-success fw-bold px-4 rounded-3">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="text-end">‡∏•‡∏ö</th></tr></thead>
                                <tbody id="personTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// ================= CONFIG =================
// üõë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô KEY ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà ‡∏à‡∏õ. ‡∏Ñ‡∏£‡∏±‡∏ö!
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

window.onload = async () => {
    initTheme();
    const today = new Date();
    document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    try {
        await loadFilterNames(); 
        await loadAttendance();
        await loadMasterTables();
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    } catch (err) {
        console.error(err);
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠', 'error');
    }
};

// ================= THEME TOGGLE =================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}

// ================= ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà Filter =================
async function loadFilterNames() {
    const { data } = await db.from('security_personnel_master').select('fullname').order('fullname');
    const select = document.getElementById('filterName');
    select.innerHTML = '<option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>'; // Reset
    if(data) {
        data.forEach(p => { select.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`; });
    }
}

// ================= ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & PDF =================
async function loadAttendance() {
    const filterMonth = document.getElementById('filterMonth').value; 
    const filterName = document.getElementById('filterName').value;

    let query = db.from('guard_attendance').select('*').order('work_date', { ascending: false }).order('created_at', { ascending: false });
    
    if (filterMonth) {
        query = query.gte('work_date', `${filterMonth}-01`).lte('work_date', `${filterMonth}-31`);
    }
    if (filterName !== 'ALL') {
        query = query.eq('fullname', filterName); // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
    }

    const { data, error } = await query;
    if (error) return console.error(error);

    const tbody = document.getElementById('attendanceTbody');
    tbody.innerHTML = '';

    if(data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
    }

    data.forEach(row => {
        let remark = row.remark_type !== '‡∏õ‡∏Å‡∏ï‡∏¥' ? `<span class="text-danger fw-bold">${row.remark_type}</span> ${row.remark_detail||''}` : '‡∏õ‡∏Å‡∏ï‡∏¥';
        tbody.innerHTML += `
            <tr>
                <td class="fw-bold text-primary">${row.work_date}</td>
                <td>${row.shift.includes('‡πÄ‡∏ä‡πâ‡∏≤') ? '‚òÄÔ∏è' : 'üåô'} <span class="opacity-75">${row.shift.split(' ')[0]}</span></td>
                <td class="fw-bold">${row.id_card}</td>
                <td>${row.fullname}</td>
                <td class="text-center text-success fw-bold">${row.time_in || '-'}</td>
                <td class="text-center text-danger fw-bold">${row.time_out || '-'}</td>
                <td>${remark}</td>
                <td class="text-center no-print">
                    <button onclick="editTime('${row.id}', '${row.time_in || ''}', '${row.time_out || ''}')" class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold"><i class="bi bi-pencil-square me-1"></i>‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤</button>
                </td>
            </tr>`;
    });
}

// ================= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!) =================
async function editTime(id, currentIn, currentOut) {
    const { value: formValues } = await Swal.fire({
        title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å',
        html: `
            <div class="text-start mt-3">
                <label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                <input id="swal-in" type="time" value="${currentIn}" class="form-control mb-3">
                <label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                <input id="swal-out" type="time" value="${currentOut}" class="form-control">
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-save2 me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        customClass: { confirmButton: 'btn btn-primary px-4', cancelButton: 'btn btn-secondary px-4' },
        buttonsStyling: false,
        preConfirm: () => {
            return {
                in: document.getElementById('swal-in').value,
                out: document.getElementById('swal-out').value
            }
        }
    });

    if (formValues) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => { Swal.showLoading(); }});
        const { error } = await db.from('guard_attendance').update({
            time_in: formValues.in || null,
            time_out: formValues.out || null,
            updated_at: new Date()
        }).eq('id', id);

        if (error) {
            Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
        } else {
            Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
            loadAttendance(); 
        }
    }
}

// ================= PDF & EXCEL =================
function exportPDF() {
    const filterMonth = document.getElementById('filterMonth').value;
    const filterName = document.getElementById('filterName');
    
    document.getElementById('print-month-label').innerText = filterMonth ? filterMonth : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    document.getElementById('print-name-label').innerText = filterName.options[filterName.selectedIndex].text;
    document.getElementById('print-date').innerText = new Date().toLocaleDateString('th-TH');

    window.print();
}

function exportExcel() {
    const month = document.getElementById('filterMonth').value;
    const name = document.getElementById('filterName').value;
    let table = document.getElementById("attendanceTable");
    let wb = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
    XLSX.writeFile(wb, `Report_${name}_${month}.xlsx`);
}

// ================= ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ MASTER DATA ‡πÅ‡∏¢‡∏Å =================
async function loadMasterTables() {
    const { data: cards } = await db.from('security_card_master').select('*').order('card_number');
    const { data: persons } = await db.from('security_personnel_master').select('*').order('fullname');

    document.getElementById('cardTbody').innerHTML = cards?.map(c => `<tr><td class="fw-bold">${c.card_number}</td><td class="text-end"><button onclick="delMaster('card', '${c.id}', '${c.card_number}')" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button></td></tr>`).join('') || '';
    document.getElementById('personTbody').innerHTML = persons?.map(p => `<tr><td class="fw-bold">${p.fullname}</td><td class="text-end"><button onclick="delMaster('person', '${p.id}', '${p.fullname}')" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button></td></tr>`).join('') || '';
}

async function addMaster(type) {
    const isCard = type === 'card';
    const inputId = isCard ? 'new_card' : 'new_person';
    const val = document.getElementById(inputId).value.trim();
    if(!val) return;

    const table = isCard ? 'security_card_master' : 'security_personnel_master';
    const payload = isCard ? { card_number: val } : { fullname: val };

    const { error } = await db.from(table).insert([payload]);
    if(!error) {
        document.getElementById(inputId).value = '';
        Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
        loadMasterTables();
        loadFilterNames(); 
    } else {
        Swal.fire('Error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

async function delMaster(type, id, name) {
    Swal.fire({
        title: `‡∏•‡∏ö ${name}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(async (result) => {
        if (result.isConfirmed) {
            const table = type === 'card' ? 'security_card_master' : 'security_personnel_master';
            await db.from(table).delete().eq('id', id);
            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
            loadMasterTables();
            loadFilterNames();
        }
    });
}
</script>
</body>
</html>