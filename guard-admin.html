<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enterprise Admin - ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* ================= PREMIUM ENTERPRISE THEME VARIABLES ================= */
        :root {
            --primary-color: #0284c7;
            --primary-hover: #0369a1;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --input-bg: #ffffff;
            --border-color: #e2e8f0;
            --table-header-bg: #f8fafc;
            --table-hover-bg: #f0f9ff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.05);
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --input-bg: #0f172a;
            --border-color: #334155;
            --table-header-bg: #0f172a;
            --table-hover-bg: rgba(2, 132, 199, 0.15);
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh; 
            padding-bottom: 40px; 
            transition: all 0.3s ease;
        }

        /* ================= SECURE LOGIN SCREEN ================= */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #e0f2fe 0%, #f1f5f9 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center;
        }
        [data-theme="dark"] #loginScreen { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        
        .login-card {
            background: var(--card-bg); padding: 45px 35px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);
            text-align: center; width: 100%; max-width: 420px;
        }

        /* ================= MAIN LAYOUT & CARDS ================= */
        .admin-card {
            background: var(--card-bg); border-radius: var(--radius-lg); padding: 25px; 
            box-shadow: var(--shadow-md); border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .admin-card:hover { box-shadow: var(--shadow-lg); }

        /* KPIs */
        .kpi-card { 
            background: var(--card-bg); border-radius: var(--radius-md); padding: 20px; 
            border: 1px solid var(--border-color); border-left: 5px solid;
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: var(--shadow-sm); 
        }
        .kpi-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; }
        .chart-container { height: 200px; width: 100%; display: flex; justify-content: center; }

        /* Navbar */
        .top-navbar {
            background: var(--card-bg); padding: 15px 20px; color: var(--text-main);
            border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); 
            margin-bottom: 35px; position: sticky; top: 0; z-index: 1000;
        }
        
        .theme-toggle { 
            background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border-color); 
            width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; 
        }
        .theme-toggle:hover { transform: scale(1.05); background: var(--table-hover-bg); }

        /* Inputs & Buttons */
        .form-control, .form-select { 
            background-color: var(--input-bg); color: var(--text-main); 
            border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 15px; font-weight: 500;
        }
        .form-control:focus, .form-select:focus { 
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15); 
        }
        
        .btn { font-weight: 600; border-radius: 10px; padding: 10px 20px; transition: all 0.2s; }
        .btn-gradient { background: linear-gradient(135deg, var(--primary-color) 0%, #0369a1 100%); color: white; border: none; }
        .btn-gradient:hover { box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3); transform: translateY(-1px); color: white; }

        /* Navigation Pills */
        .nav-pills { background: var(--card-bg); padding: 8px; border-radius: var(--radius-md); display: inline-flex; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .nav-pills .nav-link { color: var(--text-muted); font-weight: 600; border-radius: 8px; padding: 10px 25px; margin-right: 5px; transition: 0.3s; }
        .nav-pills .nav-link:hover { color: var(--primary-color); background: var(--table-hover-bg); }
        .nav-pills .nav-link.active { background: var(--primary-color); color: white; box-shadow: 0 2px 8px rgba(2, 132, 199, 0.3); }

        /* Modern Table */
        .table-responsive { border-radius: var(--radius-md); border: 1px solid var(--border-color); overflow: hidden; }
        .table { color: var(--text-main); margin-bottom: 0; }
        .table thead th { 
            background-color: var(--table-header-bg); color: var(--text-muted); 
            border-bottom: 1px solid var(--border-color); font-weight: 600; 
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; padding: 15px;
        }
        .table tbody tr:hover { background-color: var(--table-hover-bg); }
        .table td { border-color: var(--border-color); padding: 12px 15px; vertical-align: middle; }
        
        /* Drag & Drop Styles */
        .sortable-ghost { background-color: var(--table-hover-bg) !important; opacity: 0.7; border: 2px dashed var(--primary-color); }
        #attendanceTbody tr { cursor: grab; }
        #attendanceTbody tr:active { cursor: grabbing; }
        .col-hidden { display: none !important; }

        /* Loader */
        .line-spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= üñ®Ô∏è PRINT TEMPLATE (‡∏£‡∏∞‡∏î‡∏±‡∏ö Enterprise) ================= */
        .print-only { display: none; }
        
        @media print {
            @page { size: A4 portrait; margin: 10mm; }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå */
            .no-print, .btn, .theme-toggle, .top-navbar, .kpi-card, #pills-tab, .dropdown, .admin-card:not(#attendanceTableContainer) { 
                display: none !important; 
            }
            .print-only { display: table-header-group !important; } /* ‡πÉ‡∏´‡πâ Header ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô Block ‡∏Ç‡∏≠‡∏á Table */
            .print-footer-only { display: table-footer-group !important; }

            /* ‡πÅ‡∏Å‡∏∞‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß */
            body { background: white !important; color: black !important; padding: 0; font-family: 'Sarabun', sans-serif; }
            .admin-card { border: none !important; box-shadow: none !important; padding: 0 !important; border-radius: 0 !important; }
            .table-responsive { border: none !important; overflow: visible !important; }

            /* üü¢ 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡πÇ‡∏ú‡∏•‡πà‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ */
            table { page-break-inside: auto; width: 100% !important; border-collapse: collapse !important; }
            thead.print-only { display: table-header-group !important; }
            tfoot.print-footer-only { display: table-footer-group !important; }
            
            /* üü¢ 2. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
            tr { page-break-inside: avoid !important; break-inside: avoid !important; }

            /* ‡∏à‡∏±‡∏î Style ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏û‡∏¥‡∏°‡∏û‡πå */
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
            .print-header h4 { font-size: 16pt; font-weight: bold; margin: 0 0 5px 0; color: black !important; }
            
            .table { border: 0.5pt solid #000 !important; margin-top: 0 !important; }
            .table th, .table td { border: 0.5pt solid #000 !important; color: black !important; padding: 6px !important; font-size: 10pt !important; }
            .table th { background-color: #f2f2f2 !important; font-weight: bold; text-align: center; }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) */
            th[data-col="id_card"], td[data-col="id_card"] { display: none !important; }
            .col-hidden { display: none !important; } /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö */

            /* üü¢ 3. ‡∏ö‡∏µ‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
            td[data-col="remark"] { max-width: 140px !important; white-space: pre-wrap !important; word-wrap: break-word !important; font-size: 9pt !important; }

            /* ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
            .print-footer-content { margin-top: 20px; display: flex; justify-content: center; width: 100%; }
            .sign-box { width: 350px; text-align: center; color: black !important; font-size: 11pt; }
            .sign-line { border-bottom: 1px dotted #000 !important; margin: 40px auto 10px; width: 80%; }
        }
    </style>
</head>
<body>

<div id="loginScreen" class="animate__animated animate__fadeIn">
    <div class="login-card">
        <div class="mb-4 text-primary">
            <i class="bi bi-shield-lock-fill" style="font-size: 4.5rem; filter: drop-shadow(0px 4px 6px rgba(2, 132, 199, 0.3));"></i>
        </div>
        <h3 class="fw-bold mb-1">SafetyPass Admin</h3>
        <p class="text-muted small mb-4">Enterprise Security Management</p>
        <div class="input-group mb-4">
            <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-key-fill"></i></span>
            <input type="password" id="adminPin" class="form-control border-start-0 ps-0" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô PIN" onkeypress="if(event.key === 'Enter') checkLogin()">
        </div>
        <button onclick="checkLogin()" class="btn btn-gradient w-100 py-3 fs-5"><i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="loadingScreen">
    <div class="line-spinner"></div>
    <div class="fw-bold text-muted" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div id="mainApp" style="display: none;">
    <div class="top-navbar no-print">
        <div class="container-xl d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary text-white rounded-3 d-flex align-items-center justify-content-center shadow-sm" style="width: 45px; height: 45px;">
                    <i class="bi bi-shield-check fs-4"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-bold">SafetyPass Admin</h5>
                    <small class="text-muted">Enterprise Dashboard</small>
                </div>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <button class="theme-toggle" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á"><i class="bi bi-moon-stars-fill fs-5" id="themeIcon"></i></button>
                <button class="btn btn-outline-danger px-4" onclick="logout()"><i class="bi bi-power me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div class="container-xl">
        <ul class="nav nav-pills mb-4 no-print" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-attendance"><i class="bi bi-bar-chart-line-fill me-2"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-master"><i class="bi bi-database-fill-gear me-2"></i> ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-attendance">
                
                <div class="row g-4 mb-4 no-print animate__animated animate__fadeInDown">
                    <div class="col-md-8">
                        <div class="row g-4">
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #0284c7;">
                                    <div><small class="text-muted fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><h2 class="mb-0 fw-bold text-primary" id="kpi-total">0</h2></div>
                                    <div class="kpi-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-list-check"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #f59e0b;">
                                    <div><small class="text-muted fw-bold">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è</small><h2 class="mb-0 fw-bold text-warning" id="kpi-morning">0</h2></div>
                                    <div class="kpi-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-brightness-high-fill"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #334155;">
                                    <div><small class="text-muted fw-bold">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å üåô</small><h2 class="mb-0 fw-bold" style="color: #334155;" id="kpi-night">0</h2></div>
                                    <div class="kpi-icon bg-secondary bg-opacity-10 text-secondary"><i class="bi bi-moon-fill"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #ef4444;">
                                    <div><small class="text-muted fw-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏Ç‡∏≤‡∏î/‡πÅ‡∏ó‡∏ô)</small><h2 class="mb-0 fw-bold text-danger" id="kpi-issue">0</h2></div>
                                    <div class="kpi-icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-card h-100 d-flex flex-column justify-content-center">
                            <h6 class="fw-bold text-center mb-3 text-muted">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h6>
                            <div class="chart-container"><canvas id="shiftChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="admin-card mb-4 no-print animate__animated animate__fadeInUp">
                    <div class="row align-items-end g-3">
                        <div class="col-lg-2 col-md-4">
                            <label class="form-label fw-bold small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                            <input type="month" id="filterMonth" class="form-control">
                        </div>
                        <div class="col-lg-3 col-md-4">
                            <label class="form-label fw-bold small text-muted">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</label>
                            <select id="filterName" class="form-select"><option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select>
                        </div>
                        <div class="col-lg-3 col-md-4 d-flex gap-2">
                            <button onclick="loadAttendance()" class="btn btn-primary fw-bold w-100"><i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="refreshAdminData()" class="btn btn-outline-secondary fw-bold text-nowrap" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        
                        <div class="col-lg-4 col-md-12 text-lg-end mt-3 mt-lg-0 d-flex justify-content-lg-end gap-2 flex-wrap">
                            <div class="dropdown d-inline-block">
                                <button class="btn btn-light border fw-bold dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                    <i class="bi bi-layout-three-columns text-primary me-1"></i> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                                </button>
                                <ul class="dropdown-menu shadow-lg p-3" id="columnSelector" style="width: 250px;">
                                    </ul>
                            </div>
                            
                            <button id="btnSaveOrder" onclick="saveRowOrder()" class="btn btn-warning fw-bold d-none animate__animated animate__pulse"><i class="bi bi-save2 me-1"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö</button>
                            
                            <button onclick="exportExcel()" class="btn btn-success fw-bold"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
                            <button onclick="exportPDF()" class="btn btn-danger fw-bold"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button>
                        </div>
                    </div>
                </div>

                <div class="admin-card animate__animated animate__fadeInUp p-0 border-0" id="attendanceTableContainer">
                    <div class="table-responsive border-0 shadow-sm">
                        <table id="attendanceTable" class="table align-middle mb-0">
                            
                            <thead class="print-only">
                                <tr>
                                    <th colspan="8" style="border: none !important; background: white !important; padding: 0 !important;">
                                        <div class="print-header">
                                            <h4>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h4>
                                            <p class="mb-1">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏ã‡∏±‡∏°‡∏°‡∏¥‡∏ó ‡∏Æ‡∏≤‡∏£‡πå‡πÄ‡∏ô‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏°‡∏´‡∏≤‡∏ä‡∏ô)</p>
                                            <p id="printInfoLabel" class="fw-bold mb-1"></p>
                                            <p style="text-align: right; font-size: 9pt; margin: 0;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="reportPrintDate"></span></p>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <thead id="mainTableHeader">
                                <tr>
                                    <th data-col="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th data-col="shift">‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                    <th data-col="id_card">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</th>
                                    <th data-col="name">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th> 
                                    <th data-col="time_in" class="text-center">‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th>
                                    <th data-col="time_out" class="text-center">‡∏≠‡∏≠‡∏Å (OUT)</th>
                                    <th data-col="remark">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th data-col="action" class="text-center no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            
                            <tbody id="attendanceTbody"></tbody>
                            
                            <tfoot class="print-footer-only">
                                <tr>
                                    <td colspan="8" style="border: none !important; background: white !important;">
                                        <div class="print-footer-content">
                                            <div class="sign-box">
                                                <div class="sign-line"></div>
                                                <p class="mb-1">(...........................................................)</p>
                                                <p class="mb-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (‡∏à‡∏õ.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û)</p>
                                                <p class="mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p>
                                                <div class="fw-bold text-dark">Safety Health and Environment Section</div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>

                        </table>
                    </div>
                </div>

            </div>

            <div class="tab-pane fade" id="tab-master">
                <div class="row g-4"> 
                    <div class="col-md-6">
                        <div class="admin-card h-100 border-top border-4 border-primary">
                            <h5 class="fw-bold mb-4">
                                <i class="bi bi-credit-card-2-front text-primary me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (ID Cards)
                            </h5>
                            <div class="d-flex gap-2 mb-4">
                                <input type="text" id="new_card" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ ‡πÄ‡∏ä‡πà‡∏ô G-001">
                                <button onclick="addMaster('card')" class="btn btn-primary fw-bold px-4">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                            <div class="table-responsive shadow-sm border-0">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th>
                                            <th class="text-end">‡∏•‡∏ö</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cardTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card h-100 border-top border-4 border-success">
                            <h5 class="fw-bold mb-4">
                                <i class="bi bi-person-badge text-success me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Personnel)
                            </h5>
                            <div class="d-flex gap-2 mb-4">
                                <input type="text" id="new_person" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                                <button onclick="addMaster('person')" class="btn btn-success fw-bold px-4">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                            <div class="table-responsive shadow-sm border-0">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th class="text-end">‡∏•‡∏ö</th>
                                        </tr>
                                    </thead>
                                    <tbody id="personTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_PIN = "admin1234"; 

let shiftChartInstance = null;
let sortableInstance = null; 

// ================= INIT =================
window.onload = async () => {
    initTheme();
    initColumnSelector(); // üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    if(sessionStorage.getItem('isAdminLoggedIn') === 'true') {
        unlockDashboard();
    }
};

function checkLogin() {
    const pin = document.getElementById('adminPin').value;
    if(pin === ADMIN_PIN) {
        sessionStorage.setItem('isAdminLoggedIn', 'true');
        unlockDashboard();
    } else {
        Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonColor: '#dc3545' });
        document.getElementById('adminPin').value = '';
    }
}

function logout() {
    sessionStorage.removeItem('isAdminLoggedIn');
    location.reload();
}

async function unlockDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'flex';
    
    const today = new Date();
    document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    try {
        await loadFilterNames(); 
        await loadAttendance();
        await loadMasterTables();
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
    }
}

// ================= THEME =================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill text-warning' : 'bi bi-moon-stars-fill text-dark';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill text-warning' : 'bi bi-moon-stars-fill text-dark';
    if(shiftChartInstance) loadAttendance(); 
}

// ================= ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (Column Visibility) =================
function initColumnSelector() {
    const headers = document.querySelectorAll('#mainTableHeader th');
    const selectorMenu = document.getElementById('columnSelector');
    selectorMenu.innerHTML = '';

    headers.forEach((th, index) => {
        const colId = th.getAttribute('data-col');
        const colName = th.innerText;
        
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå (‡∏°‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏£‡∏¥‡∏ô‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        if(colId === 'action') return;

        // ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (id_card) ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏£‡∏¥‡∏ô‡∏ï‡πå ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        const isChecked = colId !== 'id_card' ? 'checked' : '';

        selectorMenu.innerHTML += `
            <li>
                <div class="form-check form-switch px-3 py-1">
                    <input class="form-check-input" type="checkbox" role="switch" id="colSwitch_${index}" ${isChecked} onchange="toggleColumn(${index}, this.checked)">
                    <label class="form-check-label ms-2" for="colSwitch_${index}">${colName}</label>
                </div>
            </li>
        `;
        
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏£‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Checkbox
        toggleColumn(index, colId !== 'id_card'); 
    });
}

function toggleColumn(colIndex, isVisible) {
    const table = document.getElementById('attendanceTable');
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà th (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
    const th = table.querySelectorAll(`#mainTableHeader th`)[colIndex];
    if (th) {
        isVisible ? th.classList.remove('col-hidden') : th.classList.add('col-hidden');
    }
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà td (‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß)
    const rows = table.querySelectorAll('#attendanceTbody tr');
    rows.forEach(row => {
        const td = row.querySelectorAll('td')[colIndex];
        if (td) {
            isVisible ? td.classList.remove('col-hidden') : td.classList.add('col-hidden');
        }
    });
}

// ================= ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =================
async function loadFilterNames() {
    const { data } = await db.from('security_personnel_master').select('fullname').order('fullname');
    const select = document.getElementById('filterName');
    select.innerHTML = '<option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
    if(data) data.forEach(p => { select.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`; });
}

async function refreshAdminData() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...', didOpen: () => { Swal.showLoading(); }, allowOutsideClick: false });
    await loadAttendance();
    Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1000, showConfirmButton: false });
}

async function loadAttendance() {
    const filterMonth = document.getElementById('filterMonth').value; 
    const filterName = document.getElementById('filterName').value;

    if (!filterMonth) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'warning');

    let query = db.from('guard_attendance').select('*').order('work_date', { ascending: false });
    
    const startDate = `${filterMonth}-01`;
    const lastDayInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
    const endDate = `${filterMonth}-${String(lastDayInMonth).padStart(2, '0')}`;

    query = query.gte('work_date', startDate).lte('work_date', endDate);
    if (filterName !== 'ALL') query = query.eq('fullname', filterName);

    const { data: attendanceData, error } = await query;
    if (error) return Swal.fire('Error', error.message, 'error');

    const tbody = document.getElementById('attendanceTbody');
    tbody.innerHTML = '';
    const attendanceMap = new Set(attendanceData.map(item => `${item.work_date}_${item.fullname}`));

    attendanceData.forEach(row => renderRow(row, tbody, false));

    if (filterName !== 'ALL') {
        const daysInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${filterMonth}-${String(d).padStart(2, '0')}`;
            if (!attendanceMap.has(`${dateStr}_${filterName}`)) {
                const absentRow = {
                    id: 'absent', work_date: dateStr, shift: '-', id_card: '-', fullname: filterName,
                    time_in: null, time_out: null, remark_type: '<span class="badge bg-danger">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô</span>', remark_detail: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
                };
                renderRow(absentRow, tbody, true); 
            }
        }
    }

    // ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
    const switches = document.querySelectorAll('[id^="colSwitch_"]');
    switches.forEach((sw, idx) => toggleColumn(idx, sw.checked));

    updateKPIs(attendanceData.length, attendanceData.filter(r => r.shift.includes('‡πÄ‡∏ä‡πâ‡∏≤')).length, 
               attendanceData.filter(r => r.shift.includes('‡∏î‡∏∂‡∏Å')).length, attendanceData.filter(r => r.remark_type !== '‡∏õ‡∏Å‡∏ï‡∏¥').length);

    // üü¢ ‡∏£‡∏∞‡∏ö‡∏ö Drag & Drop ‡∏•‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß
    if (sortableInstance) sortableInstance.destroy();
    sortableInstance = new Sortable(tbody, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function () {
            // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß
            document.getElementById('btnSaveOrder').classList.remove('d-none');
        }
    });
}

function renderRow(row, tbody, isAbsent) {
    const profileImg = row.profile_pic ? `<img src="${row.profile_pic}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover;" class="me-2 no-print border shadow-sm">` : '';
    tbody.innerHTML += `
        <tr class="${isAbsent ? 'bg-light opacity-75' : ''}" data-id="${row.id}" title="‡∏à‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ">
            <td data-col="date" class="fw-bold">${row.work_date}</td>
            <td data-col="shift">${row.shift}</td>
            <td data-col="id_card">${row.id_card}</td>
            <td data-col="name">${profileImg}${row.fullname}</td>
            <td data-col="time_in" class="text-center fw-bold text-success">${row.time_in || '-'}</td>
            <td data-col="time_out" class="text-center fw-bold text-danger">${row.time_out || '-'}</td>
            <td data-col="remark">${row.remark_type} <span class="text-muted d-block small">${row.remark_detail || ''}</span></td>
            <td data-col="action" class="text-center no-print">
                ${isAbsent ? '-' : `<button onclick="editTime('${row.id}', '${row.time_in}', '${row.time_out}')" class="btn btn-sm btn-light border text-primary px-3 rounded-pill"><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ</button>`}
            </td>
        </tr>`;
}

// üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏¥‡∏ô‡∏ï‡πå)
function saveRowOrder() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...', didOpen: () => { Swal.showLoading(); }});
    
    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î PDF ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á DB)
    setTimeout(() => {
        document.getElementById('btnSaveOrder').classList.add('d-none');
        Swal.fire({ 
            icon: 'success', 
            title: '‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 
            text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Export ‡πÅ‡∏•‡πâ‡∏ß',
            timer: 2000, showConfirmButton: false 
        });
    }, 600);
}

function updateKPIs(total, morning, night, issue) {
    document.getElementById('kpi-total').innerText = total;
    document.getElementById('kpi-morning').innerText = morning;
    document.getElementById('kpi-night').innerText = night;
    document.getElementById('kpi-issue').innerText = issue;

    const ctx = document.getElementById('shiftChart').getContext('2d');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if(shiftChartInstance) shiftChartInstance.destroy();
    
    shiftChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤', '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], datasets: [{ data: [morning, night, issue], backgroundColor: ['#f59e0b', '#334155', '#ef4444'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#f8fafc' : '#1e293b', font: { family: 'Sarabun' } } } } }
    });
}

// ================= ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ EXPORT =================
function exportPDF() {
    const monthText = document.getElementById('filterMonth').value || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    const nameText = document.getElementById('filterName').options[document.getElementById('filterName').selectedIndex].text;
    
    document.getElementById('printInfoLabel').innerText = `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthText} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${nameText}`;
    document.getElementById('reportPrintDate').innerText = new Date().toLocaleDateString('th-TH');
    
    setTimeout(() => { window.print(); }, 500);
}

function exportExcel() {
    let table = document.getElementById("attendanceTable");
    let wb = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
    XLSX.writeFile(wb, `Report_Attendance.xlsx`);
}

// ================= ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ MASTER DATA =================
async function loadMasterTables() {
    const { data: cards } = await db.from('security_card_master').select('*').order('card_number');
    const { data: persons } = await db.from('security_personnel_master').select('*').order('fullname');

    document.getElementById('cardTbody').innerHTML = cards?.map(c => `<tr><td class="fw-bold">${c.card_number}</td><td class="text-end"><button onclick="delMaster('card', '${c.id}', '${c.card_number}')" class="btn btn-sm btn-outline-danger px-3 rounded-pill"><i class="bi bi-trash"></i> ‡∏•‡∏ö</button></td></tr>`).join('') || '';
    document.getElementById('personTbody').innerHTML = persons?.map(p => `<tr><td class="fw-bold">${p.fullname}</td><td class="text-end"><button onclick="delMaster('person', '${p.id}', '${p.fullname}')" class="btn btn-sm btn-outline-danger px-3 rounded-pill"><i class="bi bi-trash"></i> ‡∏•‡∏ö</button></td></tr>`).join('') || '';
}

async function addMaster(type) {
    const isCard = type === 'card';
    const inputId = isCard ? 'new_card' : 'new_person';
    const val = document.getElementById(inputId).value.trim();
    if(!val) return;

    const { error } = await db.from(isCard ? 'security_card_master' : 'security_personnel_master').insert([ isCard ? { card_number: val } : { fullname: val } ]);
    if(!error) {
        document.getElementById(inputId).value = '';
        Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
        loadMasterTables(); loadFilterNames(); 
    } else { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
}

async function delMaster(type, id, name) {
    Swal.fire({
        title: `‡∏•‡∏ö ${name}?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await db.from(type === 'card' ? 'security_card_master' : 'security_personnel_master').delete().eq('id', id);
            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
            loadMasterTables(); loadFilterNames();
        }
    });
}
</script>
</body>
</html>