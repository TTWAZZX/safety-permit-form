<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enterprise Admin - ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================= THEME VARIABLES ================= */
        :root {
            --primary-color: #0ea5e9;
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #334155;
            --input-bg: #fff;
            --border-color: #e2e8f0;
            --table-hover: rgba(14, 165, 233, 0.05);
            --table-header: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --text-color: #f1f5f9;
            --input-bg: #1e293b;
            --border-color: #334155;
            --table-hover: rgba(255, 255, 255, 0.05);
            --table-header: rgba(0, 0, 0, 0.2);
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh; 
            padding-bottom: 30px; 
            transition: background-color 0.3s ease;
        }

        /* ================= SECURE LOGIN SCREEN ================= */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: var(--card-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 40px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2); text-align: center; width: 100%; max-width: 400px;
        }
        
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .line-spinner { border: 5px solid var(--border-color); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= MAIN LAYOUT & GLASS CARDS ================= */
        .admin-card {
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; padding: 25px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* KPIs & Chart */
        .kpi-card { background: var(--input-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .kpi-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .chart-container { height: 180px; width: 100%; display: flex; justify-content: center; }

        .top-navbar {
            background: linear-gradient(135deg, #0ea5e9 0%, #1e3a8a 100%);
            padding: 15px 20px; color: white; border-radius: 0 0 24px 24px; box-shadow: 0 4px 20px rgba(14, 165, 233, 0.2); margin-bottom: 30px;
        }
        
        .theme-toggle { background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }

        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border-color: var(--border-color); border-radius: 10px; }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-color); border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(14, 165, 233, 0.25); }
        
        .table { color: var(--text-color); border-color: var(--border-color); vertical-align: middle; }
        .table thead th { background-color: var(--table-header); color: var(--text-color); border-bottom: 2px solid var(--border-color); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        .table tbody tr:hover { background-color: var(--table-hover); }
        .table td { border-color: var(--border-color); }
        
        .nav-pills .nav-link { color: var(--text-color); font-weight: 600; border-radius: 12px; padding: 10px 20px; margin-right: 10px; transition: 0.3s; border: 1px solid transparent; }
        .nav-pills .nav-link:hover { background-color: rgba(14, 165, 233, 0.1); }
        .nav-pills .nav-link.active { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }

        .btn-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; font-weight: 600; transition: 0.3s; }
        .btn-gradient:hover { box-shadow: 0 5px 15px rgba(14, 165, 233, 0.4); transform: translateY(-2px); }

        /* ================= PRINT TEMPLATE (PDF ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£) ================= */
        .print-only { display: none; }
        
        @media print {
            @page { size: A4 portrait; margin: 15mm; }
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: black !important; padding: 0; }
            .no-print { display: none !important; }
            .admin-card { box-shadow: none !important; border: none !important; padding: 0 !important; background: transparent !important; }
            
            .print-only { display: block; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            .print-header h3 { font-weight: bold; font-size: 18pt; margin-bottom: 5px; color: black; }
            .print-header p { font-size: 12pt; margin: 0; color: black; }
            
            .table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #000 !important; }
            .table th, .table td { border: 1px solid #000 !important; padding: 8px !important; font-size: 11pt !important; color: #000 !important; }
            .table th { background-color: #f0f0f0 !important; font-weight: bold; text-align: center; }
            
            .print-footer { display: flex; justify-content: space-around; margin-top: 50px; page-break-inside: avoid; }
            .sign-box { text-align: center; width: 200px; color: black; }
            .sign-line { border-bottom: 1px dashed #000; margin-bottom: 10px; height: 30px; }
        }
    </style>
</head>
<body>

<div id="loginScreen" class="animate__animated animate__fadeIn">
    <div class="login-card">
        <i class="bi bi-shield-lock-fill text-primary" style="font-size: 4rem;"></i>
        <h4 class="fw-bold mt-3 mb-1">Security Admin</h4>
        <p class="text-muted small mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        <div class="input-group mb-3">
            <span class="input-group-text bg-light"><i class="bi bi-key-fill"></i></span>
            <input type="password" id="adminPin" class="form-control form-control-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PIN)" onkeypress="if(event.key === 'Enter') checkLogin()">
        </div>
        <button onclick="checkLogin()" class="btn btn-gradient w-100 py-3 rounded-3 fs-5"><i class="bi bi-box-arrow-in-right me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="loadingScreen">
    <div class="line-spinner"></div>
    <div class="loading-text-main" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div id="mainApp" style="display: none;">
    <div class="top-navbar no-print">
        <div class="container-xl d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-lock-fill fs-2 me-3"></i>
                <div>
                    <h4 class="mb-0 fw-bold">Security Admin</h4>
                    <small class="opacity-75">Enterprise Dashboard</small>
                </div>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <button class="theme-toggle" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á"><i class="bi bi-moon-stars-fill fs-5" id="themeIcon"></i></button>
                <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i>‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div class="container-xl">
        <ul class="nav nav-pills mb-4 no-print" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-attendance"><i class="bi bi-bar-chart-line-fill me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-master"><i class="bi bi-database-fill-gear me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ï‡∏£/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-attendance">
                
                <div class="row g-3 mb-4 no-print animate__animated animate__fadeInDown">
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="kpi-card border-start border-4 border-primary">
                                    <div><small class="text-muted fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><h3 class="mb-0 fw-bold text-primary" id="kpi-total">0</h3></div>
                                    <div class="kpi-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-list-check"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card border-start border-4 border-warning">
                                    <div><small class="text-muted fw-bold">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è</small><h3 class="mb-0 fw-bold text-warning" id="kpi-morning">0</h3></div>
                                    <div class="kpi-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-brightness-high-fill"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card border-start border-4 border-dark">
                                    <div><small class="text-muted fw-bold">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å üåô</small><h3 class="mb-0 fw-bold text-dark" id="kpi-night">0</h3></div>
                                    <div class="kpi-icon bg-dark bg-opacity-10 text-dark"><i class="bi bi-moon-fill"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card border-start border-4 border-danger">
                                    <div><small class="text-muted fw-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏Ñ‡∏ß‡∏á‡∏Å‡∏∞/‡πÅ‡∏ó‡∏ô)</small><h3 class="mb-0 fw-bold text-danger" id="kpi-issue">0</h3></div>
                                    <div class="kpi-icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-card h-100 d-flex flex-column justify-content-center pb-2 pt-3">
                            <h6 class="fw-bold text-center mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞</h6>
                            <div class="chart-container"><canvas id="shiftChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="print-only print-header">
                    <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏£‡∏õ‡∏†.)</h3>
                    <p>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <span id="print-month-label" class="fw-bold">-</span> | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="print-name-label" class="fw-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></p>
                    <p style="font-size: 10pt; text-align: right; margin-top: 5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="print-date"></span></p>
                </div>

                <div class="admin-card mb-4 no-print animate__animated animate__fadeInUp">
                    <div class="row align-items-end g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input type="month" id="filterMonth" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                            <select id="filterName" class="form-select"><option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select>
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                            <button onclick="loadAttendance()" class="btn btn-gradient w-100 fw-bold rounded-3"><i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="refreshAdminData()" class="btn btn-secondary fw-bold rounded-3 text-nowrap" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"><i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                        </div>
                        <div class="col-md-3 text-end">
                            <button onclick="exportExcel()" class="btn btn-success fw-bold me-2 rounded-3"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                            <button onclick="exportPDF()" class="btn btn-danger fw-bold rounded-3"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                        </div>
                    </div>
                </div>

                <div class="admin-card animate__animated animate__fadeInUp">
                    <div class="table-responsive">
                        <table id="attendanceTable" class="table align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th>‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th> <th class="text-center">‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th>
                                    <th class="text-center">‡∏≠‡∏≠‡∏Å (OUT)</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th class="text-center no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="print-only print-footer">
                    <div class="sign-box"><div class="sign-line"></div><p>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∏‡∏î</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p></div>
                    <div class="sign-box"><div class="sign-line"></div><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏à‡∏õ./‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-master">
                <div class="row g-4 no-print">
                    <div class="col-md-6">
                        <div class="admin-card h-100">
                            <h5 class="fw-bold mb-4 text-primary"><i class="bi bi-credit-card-2-front me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (ID Cards)</h5>
                            <div class="d-flex gap-2 mb-3">
                                <input type="text" id="new_card" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô G-001">
                                <button onclick="addMaster('card')" class="btn btn-primary fw-bold px-4 rounded-3">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                            <div class="table-responsive"><table class="table table-hover"><thead><tr><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th class="text-end">‡∏•‡∏ö</th></tr></thead><tbody id="cardTbody"></tbody></table></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card h-100">
                            <h5 class="fw-bold mb-4 text-success"><i class="bi bi-person-badge me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Personnel)</h5>
                            <div class="d-flex gap-2 mb-3">
                                <input type="text" id="new_person" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                                <button onclick="addMaster('person')" class="btn btn-success fw-bold px-4 rounded-3">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                            <div class="table-responsive"><table class="table table-hover"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="text-end">‡∏•‡∏ö</th></tr></thead><tbody id="personTbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_PIN = "admin1234"; 

let shiftChartInstance = null;

// ================= INIT & SECURITY =================
window.onload = async () => {
    initTheme();
    if(sessionStorage.getItem('isAdminLoggedIn') === 'true') {
        unlockDashboard();
    }
};

function checkLogin() {
    const pin = document.getElementById('adminPin').value;
    if(pin === ADMIN_PIN) {
        sessionStorage.setItem('isAdminLoggedIn', 'true');
        unlockDashboard();
    } else {
        Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', confirmButtonColor: '#dc3545' });
        document.getElementById('adminPin').value = '';
    }
}

function logout() {
    sessionStorage.removeItem('isAdminLoggedIn');
    location.reload();
}

async function unlockDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'flex';
    
    const today = new Date();
    document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    try {
        await loadFilterNames(); 
        await loadAttendance();
        await loadMasterTables();
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
    }
}

// ================= THEME TOGGLE =================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
    if(shiftChartInstance) loadAttendance(); 
}

// ================= ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà Filter =================
async function loadFilterNames() {
    const { data } = await db.from('security_personnel_master').select('fullname').order('fullname');
    const select = document.getElementById('filterName');
    select.innerHTML = '<option value="ALL">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
    if(data) data.forEach(p => { select.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`; });
}

// ================= üü¢ ‡∏õ‡∏∏‡πà‡∏° REFRESH ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =================
async function refreshAdminData() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...', didOpen: () => { Swal.showLoading(); }, allowOutsideClick: false });
    await loadAttendance();
    Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1000, showConfirmButton: false });
}

// ================= ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & KPIs & Audit Trail =================
// ================= ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô =================
async function loadAttendance() {
    const filterMonth = document.getElementById('filterMonth').value; 
    const filterName = document.getElementById('filterName').value;

    if (!filterMonth) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'warning');

    // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Master ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
    const { data: allPersonnel } = await db.from('security_personnel_master').select('fullname');
    
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
    let query = db.from('guard_attendance').select('*').order('work_date', { ascending: false });
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const startDate = `${filterMonth}-01`;
    const lastDayInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
    const endDate = `${filterMonth}-${String(lastDayInMonth).padStart(2, '0')}`;

    query = query.gte('work_date', startDate).lte('work_date', endDate);
    
    if (filterName !== 'ALL') query = query.eq('fullname', filterName);

    const { data: attendanceData, error } = await query;
    
    if (error) {
        console.error("Supabase Error:", error);
        return Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
    }

    const tbody = document.getElementById('attendanceTbody');
    tbody.innerHTML = '';

    // 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Logic ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô ‡πÉ‡∏Ñ‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡πâ‡∏≤‡∏á
    const attendanceMap = new Set(attendanceData.map(item => `${item.work_date}_${item.fullname}`));

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏¥‡∏°)
    attendanceData.forEach(row => {
        renderRow(row, tbody, false); // false ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
    });

    // 4. [‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡πá‡∏î] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏á "‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" 
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏≤ "‡πÑ‡∏°‡πà‡∏°‡∏≤" (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
    if (filterName !== 'ALL') {
        const daysInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${filterMonth}-${String(d).padStart(2, '0')}`;
            // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà d ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
            if (!attendanceMap.has(`${dateStr}_${filterName}`)) {
                const absentRow = {
                    work_date: dateStr,
                    shift: '-',
                    id_card: '-',
                    fullname: filterName,
                    time_in: null,
                    time_out: null,
                    remark_type: '<span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô / ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô</span>',
                    remark_detail: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                };
                renderRow(absentRow, tbody, true); // true ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô
            }
        }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï KPIs (‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á)
    updateKPIs(attendanceData.length, 
               attendanceData.filter(r => r.shift.includes('‡πÄ‡∏ä‡πâ‡∏≤')).length, 
               attendanceData.filter(r => r.shift.includes('‡∏î‡∏∂‡∏Å')).length, 
               attendanceData.filter(r => r.remark_type !== '‡∏õ‡∏Å‡∏ï‡∏¥').length);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ß (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î)
function renderRow(row, tbody, isAbsent) {
    const editBadge = (row.updated_by) ? `<i class="bi bi-pencil-fill ${(row.updated_by === 'Admin' ? 'text-warning' : 'text-info')} ms-2"></i>` : '';
    const profileImg = row.profile_pic ? `<img src="${row.profile_pic}" style="width: 25px; height: 25px; border-radius: 50%;" class="me-2 no-print">` : '';

    tbody.innerHTML += `
        <tr class="${isAbsent ? 'table-light opacity-75' : ''}">
            <td class="fw-bold">${row.work_date}</td>
            <td>${row.shift}</td>
            <td>${row.id_card}</td>
            <td>${profileImg}${row.fullname}</td>
            <td class="text-center fw-bold text-success">${row.time_in || (isAbsent ? '-' : '-')}</td>
            <td class="text-center fw-bold text-danger">${row.time_out || (isAbsent ? '-' : '-')}</td>
            <td>${row.remark_type} ${row.remark_detail || ''}</td>
            <td class="text-center no-print">
                ${isAbsent ? '-' : `<button onclick="editTime('${row.id}', '${row.time_in}', '${row.time_out}')" class="btn btn-sm btn-outline-primary rounded-pill">‡πÅ‡∏Å‡πâ</button>`}
            </td>
        </tr>`;
}

function updateKPIs(total, morning, night, issue) {
    document.getElementById('kpi-total').innerText = total;
    document.getElementById('kpi-morning').innerText = morning;
    document.getElementById('kpi-night').innerText = night;
    document.getElementById('kpi-issue').innerText = issue;

    const ctx = document.getElementById('shiftChart').getContext('2d');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f1f5f9' : '#334155';

    if(shiftChartInstance) shiftChartInstance.destroy();
    
    shiftChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤', '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'],
            datasets: [{ data: [morning, night, issue], backgroundColor: ['#f59e0b', '#1e293b', '#ef4444'], borderWidth: 0 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, cutout: '70%',
            plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { family: 'Sarabun' } } } }
        }
    });
}

// ================= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Trail) =================
async function editTime(id, currentIn, currentOut) {
    const { value: formValues } = await Swal.fire({
        title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (Admin)',
        html: `
            <div class="text-start mt-3">
                <label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                <input id="swal-in" type="time" value="${currentIn}" class="form-control mb-3">
                <label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                <input id="swal-out" type="time" value="${currentOut}" class="form-control">
            </div>
        `,
        focusConfirm: false, showCancelButton: true,
        confirmButtonText: '<i class="bi bi-save2 me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        customClass: { confirmButton: 'btn btn-primary px-4', cancelButton: 'btn btn-secondary px-4' },
        buttonsStyling: false,
        preConfirm: () => { return { in: document.getElementById('swal-in').value, out: document.getElementById('swal-out').value } }
    });

    if (formValues) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => { Swal.showLoading(); }});
        
        const { error } = await db.from('guard_attendance').update({
            time_in: formValues.in || null,
            time_out: formValues.out || null,
            updated_at: new Date(),
            updated_by: 'Admin'
        }).eq('id', id);

        if (error) {
            Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
        } else {
            Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß', timer: 2000, showConfirmButton: false });
            loadAttendance(); 
        }
    }
}

// ================= PDF & EXCEL =================
function exportPDF() {
    const filterMonth = document.getElementById('filterMonth').value;
    const filterName = document.getElementById('filterName');
    
    document.getElementById('print-month-label').innerText = filterMonth ? filterMonth : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    document.getElementById('print-name-label').innerText = filterName.options[filterName.selectedIndex].text;
    document.getElementById('print-date').innerText = new Date().toLocaleDateString('th-TH');
    window.print();
}

function exportExcel() {
    const month = document.getElementById('filterMonth').value;
    const name = document.getElementById('filterName').value;
    let table = document.getElementById("attendanceTable");
    let wb = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
    XLSX.writeFile(wb, `Report_${name}_${month}.xlsx`);
}

// ================= ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ MASTER DATA ‡πÅ‡∏¢‡∏Å =================
async function loadMasterTables() {
    const { data: cards } = await db.from('security_card_master').select('*').order('card_number');
    const { data: persons } = await db.from('security_personnel_master').select('*').order('fullname');

    document.getElementById('cardTbody').innerHTML = cards?.map(c => `<tr><td class="fw-bold">${c.card_number}</td><td class="text-end"><button onclick="delMaster('card', '${c.id}', '${c.card_number}')" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button></td></tr>`).join('') || '';
    document.getElementById('personTbody').innerHTML = persons?.map(p => `<tr><td class="fw-bold">${p.fullname}</td><td class="text-end"><button onclick="delMaster('person', '${p.id}', '${p.fullname}')" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button></td></tr>`).join('') || '';
}

async function addMaster(type) {
    const isCard = type === 'card';
    const inputId = isCard ? 'new_card' : 'new_person';
    const val = document.getElementById(inputId).value.trim();
    if(!val) return;

    const table = isCard ? 'security_card_master' : 'security_personnel_master';
    const payload = isCard ? { card_number: val } : { fullname: val };

    const { error } = await db.from(table).insert([payload]);
    if(!error) {
        document.getElementById(inputId).value = '';
        Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
        loadMasterTables();
        loadFilterNames(); 
    } else { Swal.fire('Error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
}

async function delMaster(type, id, name) {
    Swal.fire({
        title: `‡∏•‡∏ö ${name}?`, icon: 'warning', showCancelButton: true,
        confirmButtonColor: '#dc3545', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(async (result) => {
        if (result.isConfirmed) {
            const table = type === 'card' ? 'security_card_master' : 'security_personnel_master';
            await db.from(table).delete().eq('id', id);
            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
            loadMasterTables(); loadFilterNames();
        }
    });
}
</script>
</body>
</html>