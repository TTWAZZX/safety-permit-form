<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enterprise Admin - ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏õ‡∏†.</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* ================= PREMIUM ENTERPRISE THEME VARIABLES ================= */
        :root {
            --primary-color: #0284c7;
            --primary-hover: #0369a1;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --input-bg: #ffffff;
            --border-color: #e2e8f0;
            --table-header-bg: #f8fafc;
            --table-hover-bg: #f0f9ff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.05);
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --input-bg: #0f172a;
            --border-color: #334155;
            --table-header-bg: #0f172a;
            --table-hover-bg: rgba(2, 132, 199, 0.15);
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh; 
            padding-bottom: 40px; 
            transition: background-color 0.3s ease;
        }

        /* ================= SECURE LOGIN ================= */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #e0f2fe 0%, #f1f5f9 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center;
        }
        [data-theme="dark"] #loginScreen { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        
        .login-card {
            background: var(--card-bg); padding: 45px 35px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);
            text-align: center; width: 100%; max-width: 420px;
        }

        /* ================= MAIN CARDS & KPIs ================= */
        .admin-card {
            background: var(--card-bg); border-radius: var(--radius-lg); padding: 25px; 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        }

        .kpi-card { 
            background: var(--card-bg); border-radius: var(--radius-md); padding: 20px; 
            border: 1px solid var(--border-color); border-left: 5px solid;
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: var(--shadow-sm); transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kpi-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .chart-container { height: 180px; width: 100%; display: flex; justify-content: center; }

        /* ================= NAVBAR & CONTROLS ================= */
        .top-navbar {
            background: var(--card-bg); padding: 15px 20px; color: var(--text-main);
            border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); 
            margin-bottom: 35px; position: sticky; top: 0; z-index: 1020;
        }
        
        .theme-toggle { 
            background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border-color); 
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; 
        }
        .theme-toggle:hover { background: var(--table-hover-bg); }

        .form-control, .form-select { 
            background-color: var(--input-bg); color: var(--text-main); 
            border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; font-weight: 500;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
        }
        .form-control:focus, .form-select:focus { 
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15); 
        }
        
        .btn { font-weight: 600; border-radius: 8px; padding: 10px 20px; transition: all 0.2s; }
        .btn-gradient { background: linear-gradient(135deg, var(--primary-color) 0%, #0369a1 100%); color: white; border: none; }
        .btn-gradient:hover { box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3); transform: translateY(-1px); color: white; }

        .nav-pills { background: var(--card-bg); padding: 6px; border-radius: var(--radius-md); display: inline-flex; border: 1px solid var(--border-color); }
        .nav-pills .nav-link { color: var(--text-muted); font-weight: 600; border-radius: 8px; padding: 10px 25px; transition: 0.3s; }
        .nav-pills .nav-link:hover { color: var(--primary-color); background: var(--table-hover-bg); }
        .nav-pills .nav-link.active { background: var(--primary-color); color: white; }

        /* ================= TABLE DESIGN ================= */
        .table-responsive { border-radius: var(--radius-md); border: 1px solid var(--border-color); } 
        .table { color: var(--text-main); margin-bottom: 0; }
        .table thead th { 
            background-color: var(--table-header-bg); color: var(--text-muted); 
            border-bottom: 1px solid var(--border-color); font-weight: 600; 
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; padding: 16px 15px;
            position: sticky; top: 0; z-index: 5;
        }
        .table tbody tr { transition: background-color 0.15s; }
        .table tbody tr:hover { background-color: var(--table-hover-bg); }
        .table td { border-color: var(--border-color); padding: 14px 15px; vertical-align: middle; }
        
        .sortable-ghost { background-color: var(--table-hover-bg) !important; opacity: 0.8; border: 2px dashed var(--primary-color); }
        #attendanceTbody tr { cursor: grab; }
        #attendanceTbody tr:active { cursor: grabbing; }
        .col-hidden { display: none !important; }

        /* ================= LOADER ================= */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .line-spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ================= üñ®Ô∏è PRINT TEMPLATE (STRICTLY FORMAL & BORDER FIX) ================= */
        .print-only { display: none; }
        
        @media print {
            @page { size: A4 portrait; margin: 15mm 10mm; } 
            
            .no-print, .btn, .theme-toggle, .top-navbar, .kpi-card, #pills-tab, .dropdown, .admin-card:not(#attendanceTableContainer) { display: none !important; }
            .print-only { display: block !important; } 

            body, * { background: white !important; color: black !important; font-family: 'Sarabun', sans-serif !important; }
            
            .admin-card { border: none !important; box-shadow: none !important; padding: 0 !important; border-radius: 0 !important; }
            .table-responsive { border: none !important; overflow: visible !important; }

            .badge { border: none !important; background: transparent !important; color: black !important; padding: 0 !important; font-size: 10pt !important; font-weight: normal !important; }
            i { display: none !important; } 
            
            /* 1. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô */
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 12px; margin-bottom: 12px; }
            .print-header h4 { font-size: 16pt; font-weight: bold; margin: 0 0 6px 0; color: black !important; }
            .print-header p { font-size: 11pt; margin: 0 0 4px 0; color: black !important; }
            
            /* üü¢ 2. ‡∏ó‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏¢‡πÄ‡∏à‡∏≤‡∏∞‡πÄ‡∏Å‡∏£‡∏≤‡∏∞ Bootstrap ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡πÄ‡∏™‡πâ‡∏ô */
            table#attendanceTable, table#attendanceTable.table { 
                width: 100% !important; 
                max-width: 100% !important;
                border-collapse: collapse !important; 
                border: 1px solid #000 !important; 
                margin-top: 0;
            }
            #attendanceTable thead { display: table-header-group !important; }
            #attendanceTable tr { page-break-inside: avoid !important; break-inside: avoid !important; }

            /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            table#attendanceTable.table > :not(caption) > * > *,
            table#attendanceTable th, 
            table#attendanceTable td { 
                border: 1px solid #000 !important; 
                padding: 6px 8px !important; 
                font-size: 10pt !important; 
                vertical-align: middle !important;
            }
            
            thead#mainTableHeader th { 
                background-color: #f2f2f2 !important; 
                font-weight: bold !important; 
                text-align: center !important; 
                text-transform: none !important; 
                font-size: 11pt !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
            th[data-col="id_card"], td[data-col="id_card"] { display: none !important; }
            .col-hidden { display: none !important; } 
            
            /* üü¢ 3. ‡∏≠‡∏∏‡∏î‡∏£‡∏π‡∏£‡∏±‡πà‡∏ß‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ */
            table#attendanceTable th[data-col="remark"], 
            table#attendanceTable td[data-col="remark"] { 
                border-right: 1px solid #000 !important; 
                max-width: 140px !important; 
                white-space: pre-wrap !important; 
                word-wrap: break-word !important; 
                font-size: 9pt !important; 
            }

            /* ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå */
            .print-footer-content { display: block !important; margin-top: 40px; page-break-inside: avoid; }
            .sign-box-container { display: flex; justify-content: center; width: 100%; }
            .sign-box { width: 320px; text-align: center; font-size: 11pt; }
            .sign-line { border-bottom: 1px solid #000 !important; margin: 40px auto 10px; width: 90%; } 
        }
    </style>
</head>
<body>

<div id="loginScreen" class="animate__animated animate__fadeIn">
    <div class="login-card">
        <div class="mb-4 text-primary">
            <i class="bi bi-shield-lock" style="font-size: 4rem;"></i>
        </div>
        <h3 class="fw-bold mb-1">SafetyPass Admin</h3>
        <p class="text-muted small mb-4">Enterprise Security Management</p>
        <div class="input-group mb-4 shadow-sm rounded-3">
            <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-key"></i></span>
            <input type="password" id="adminPin" class="form-control border-start-0 ps-0 form-control-lg" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô PIN" onkeypress="if(event.key === 'Enter') checkLogin()">
        </div>
        <button onclick="checkLogin()" class="btn btn-gradient w-100 py-3 fs-5 rounded-3"><i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="loadingScreen">
    <div class="line-spinner"></div>
    <div class="fw-bold text-muted" id="loadStatusMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div id="mainApp" style="display: none;">
    <div class="top-navbar no-print">
        <div class="container-xl d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                    <i class="bi bi-shield-check fs-4"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-bold">SafetyPass Admin</h5>
                    <small class="text-muted">Enterprise Dashboard</small>
                </div>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <button class="theme-toggle" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á"><i class="bi bi-moon" id="themeIcon"></i></button>
                <button class="btn btn-light border text-danger px-4" onclick="logout()"><i class="bi bi-power me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div class="container-xl">
        <div class="d-flex justify-content-center mb-4 no-print">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-attendance"><i class="bi bi-grid me-2"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î & ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-master"><i class="bi bi-people me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button></li>
            </ul>
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-attendance">
                
                <div class="row g-3 mb-4 no-print animate__animated animate__fadeInDown">
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #0284c7;">
                                    <div><small class="text-muted fw-bold"><i class="bi bi-file-earmark-text me-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><h2 class="mb-0 fw-bold text-primary mt-1" id="kpi-total">0</h2></div>
                                    <div class="kpi-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-list-ul"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #f59e0b;">
                                    <div><small class="text-muted fw-bold"><i class="bi bi-sun me-1"></i> ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (Day Shift)</small><h2 class="mb-0 fw-bold text-warning mt-1" id="kpi-morning">0</h2></div>
                                    <div class="kpi-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-brightness-high"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #334155;">
                                    <div><small class="text-muted fw-bold"><i class="bi bi-moon-stars me-1"></i> ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (Night Shift)</small><h2 class="mb-0 fw-bold mt-1" style="color: #334155;" id="kpi-night">0</h2></div>
                                    <div class="kpi-icon bg-secondary bg-opacity-10 text-secondary"><i class="bi bi-moon"></i></div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="kpi-card" style="border-left-color: #ef4444;">
                                    <div><small class="text-muted fw-bold"><i class="bi bi-clock-history me-1"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (No Record)</small><h2 class="mb-0 fw-bold text-danger mt-1" id="kpi-issue">0</h2></div>
                                    <div class="kpi-icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-clipboard-x"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-card h-100 d-flex flex-column justify-content-center">
                            <h6 class="fw-bold text-center mb-3 text-muted">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h6>
                            <div class="chart-container"><canvas id="shiftChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="admin-card mb-4 no-print animate__animated animate__fadeInUp" style="position: relative; z-index: 10;">
                    <div class="row align-items-end g-3">
                        <div class="col-lg-2 col-md-3">
                            <label class="form-label fw-bold small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input type="month" id="filterMonth" class="form-control">
                        </div>
                        <div class="col-lg-2 col-md-3">
                            <label class="form-label fw-bold small text-muted">‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</label>
                            <select id="filterName" class="form-select"><option value="ALL">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option></select>
                        </div>
                        <div class="col-lg-2 col-md-3">
                            <label class="form-label fw-bold small text-muted">‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                            <select id="filterShift" class="form-select">
                                <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡πÄ‡∏ä‡πâ‡∏≤">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</option>
                                <option value="‡∏î‡∏∂‡∏Å">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-3 d-flex gap-2">
                            <button onclick="loadAttendance()" class="btn btn-primary fw-bold w-100"><i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="refreshAdminData()" class="btn btn-light border text-muted" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        
                        <div class="col-lg-4 col-md-12 text-lg-end mt-3 mt-lg-0 d-flex justify-content-lg-end gap-2 flex-wrap">
                            <div class="dropdown d-inline-block">
                                <button class="btn btn-light border fw-bold dropdown-toggle text-muted" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                    <i class="bi bi-layout-three-columns me-1"></i> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                                </button>
                                <ul class="dropdown-menu shadow-lg p-3 border-0" id="columnSelector" style="width: 220px; z-index: 1050;"></ul>
                            </div>
                            
                            <button id="btnSaveOrder" onclick="saveRowOrder()" class="btn btn-warning fw-bold d-none animate__animated animate__pulse"><i class="bi bi-save2 me-1"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö</button>
                            
                            <button onclick="exportExcel()" class="btn btn-success fw-bold"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
                            <button onclick="exportPDF()" class="btn btn-danger fw-bold"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button>
                        </div>
                    </div>
                </div>

                <div class="admin-card animate__animated animate__fadeInUp p-0 border-0" id="attendanceTableContainer">
                    
                    <div class="print-only print-header">
                        <h4>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h4>
                        <p class="fw-bold">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏ã‡∏±‡∏°‡∏°‡∏¥‡∏ó ‡∏Æ‡∏≤‡∏£‡πå‡πÄ‡∏ô‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏°‡∏´‡∏≤‡∏ä‡∏ô)</p>
                        <p id="printInfoLabel"></p>
                        <p style="text-align: right; font-size: 10pt; margin-top: 8px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="reportPrintDate"></span></p>
                    </div>

                    <div class="table-responsive border-0 shadow-sm" style="overflow: visible;"> 
                        <table id="attendanceTable" class="table align-middle mb-0">
                            <thead id="mainTableHeader">
                                <tr>
                                    <th data-col="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th data-col="shift">‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                    <th data-col="id_card">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</th>
                                    <th data-col="name">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th> 
                                    <th data-col="time_in" class="text-center">‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th>
                                    <th data-col="time_out" class="text-center">‡∏≠‡∏≠‡∏Å (OUT)</th>
                                    <th data-col="remark">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th data-col="action" class="text-center no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            
                            <tbody id="attendanceTbody"></tbody>
                        </table>
                    </div>
                    
                    <div class="print-only print-footer-content">
                        <div class="sign-box-container">
                            <div class="sign-box">
                                <div class="sign-line"></div>
                                <p class="mb-1">(...........................................................)</p>
                                <p class="mb-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (‡∏à‡∏õ.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û)</p>
                                <p class="mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____/_____/_____</p>
                                <div class="fw-bold text-dark">Safety Health and Environment Section</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-master">
                <div class="row g-4"> 
                    <div class="col-md-6">
                        <div class="admin-card h-100 border-top border-4 border-primary">
                            <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                                <div class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex justify-content-center align-items-center me-3" style="width:40px; height:40px;">
                                    <i class="bi bi-credit-card-2-front fs-5"></i>
                                </div>
                                <h5 class="fw-bold mb-0 text-primary">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</h5>
                            </div>
                            <div class="input-group mb-4 shadow-sm">
                                <input type="text" id="new_card" class="form-control bg-light" placeholder="‡πÄ‡∏ä‡πà‡∏ô G-001">
                                <button onclick="addMaster('card')" class="btn btn-primary fw-bold px-4"><i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</button>
                            </div>
                            <div class="table-responsive shadow-sm border-0 rounded-3">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="text-muted"><small>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</small></th>
                                            <th class="text-end text-muted"><small>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</small></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cardTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card h-100 border-top border-4 border-success">
                            <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                                <div class="bg-success bg-opacity-10 text-success rounded-3 d-flex justify-content-center align-items-center me-3" style="width:40px; height:40px;">
                                    <i class="bi bi-person-badge fs-5"></i>
                                </div>
                                <h5 class="fw-bold mb-0 text-success">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                            </div>
                            <div class="input-group mb-4 shadow-sm">
                                <input type="text" id="new_person" class="form-control bg-light" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                                <button onclick="addMaster('person')" class="btn btn-success fw-bold px-4"><i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
                            </div>
                            <div class="table-responsive shadow-sm border-0 rounded-3">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="text-muted"><small>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</small></th>
                                            <th class="text-end text-muted"><small>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</small></th>
                                        </tr>
                                    </thead>
                                    <tbody id="personTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_PIN = "admin1234"; 

let shiftChartInstance = null;
let sortableInstance = null; 

// ================= TOAST NOTIFICATION =================
const Toast = Swal.mixin({
    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
});

// ================= INIT =================
window.onload = async () => {
    initTheme();
    initColumnSelector(); 
    if(sessionStorage.getItem('isAdminLoggedIn') === 'true') {
        unlockDashboard();
    }
};

function checkLogin() {
    const pin = document.getElementById('adminPin').value;
    if(pin === ADMIN_PIN) {
        sessionStorage.setItem('isAdminLoggedIn', 'true');
        unlockDashboard();
    } else {
        Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonColor: '#dc3545' });
        document.getElementById('adminPin').value = '';
    }
}

function logout() {
    sessionStorage.removeItem('isAdminLoggedIn');
    location.reload();
}

async function unlockDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'flex';
    
    const today = new Date();
    document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    try {
        await loadFilterNames(); 
        await loadAttendance();
        await loadMasterTables();
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
    }
}

// ================= THEME =================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-sun text-warning' : 'bi bi-moon text-muted';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    document.getElementById('themeIcon').className = next === 'dark' ? 'bi bi-sun text-warning' : 'bi bi-moon text-muted';
    if(shiftChartInstance) loadAttendance(); 
}

// ================= ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå =================
function initColumnSelector() {
    const headers = document.querySelectorAll('#mainTableHeader th');
    const selectorMenu = document.getElementById('columnSelector');
    selectorMenu.innerHTML = '';

    headers.forEach((th, index) => {
        const colId = th.getAttribute('data-col');
        const colName = th.innerText;
        if(colId === 'action') return;
        const isChecked = colId !== 'id_card' ? 'checked' : '';
        selectorMenu.innerHTML += `
            <li>
                <div class="form-check form-switch px-3 py-2 border-bottom border-light">
                    <input class="form-check-input" type="checkbox" role="switch" id="colSwitch_${index}" ${isChecked} onchange="toggleColumn(${index}, this.checked)">
                    <label class="form-check-label ms-2 small text-muted fw-bold" for="colSwitch_${index}">${colName}</label>
                </div>
            </li>
        `;
        toggleColumn(index, colId !== 'id_card'); 
    });
}

function toggleColumn(colIndex, isVisible) {
    const table = document.getElementById('attendanceTable');
    const th = table.querySelectorAll(`#mainTableHeader th`)[colIndex];
    if (th) isVisible ? th.classList.remove('col-hidden') : th.classList.add('col-hidden');
    
    const rows = table.querySelectorAll('#attendanceTbody tr');
    rows.forEach(row => {
        const td = row.querySelectorAll('td')[colIndex];
        if (td) isVisible ? td.classList.remove('col-hidden') : td.classList.add('col-hidden');
    });
}

// ================= ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =================
async function loadFilterNames() {
    const { data } = await db.from('security_personnel_master').select('fullname').order('fullname');
    const select = document.getElementById('filterName');
    select.innerHTML = '<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>';
    if(data) data.forEach(p => { select.innerHTML += `<option value="${p.fullname}">${p.fullname}</option>`; });
}

async function refreshAdminData() {
    Toast.fire({ icon: 'info', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' });
    await loadAttendance();
    Toast.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
}

async function loadAttendance() {
    const filterMonth = document.getElementById('filterMonth').value; 
    const filterName = document.getElementById('filterName').value;
    const filterShift = document.getElementById('filterShift').value; 

    if (!filterMonth) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'warning');

    let query = db.from('guard_attendance').select('*')
                .order('work_date', { ascending: true }) 
                .order('shift', { ascending: true })
                .order('fullname', { ascending: true });
    
    const startDate = `${filterMonth}-01`;
    const lastDayInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
    const endDate = `${filterMonth}-${String(lastDayInMonth).padStart(2, '0')}`;

    query = query.gte('work_date', startDate).lte('work_date', endDate);
    if (filterName !== 'ALL') query = query.eq('fullname', filterName);
    if (filterShift !== 'ALL') query = query.ilike('shift', `%${filterShift}%`);

    const { data: attendanceData, error } = await query;
    if (error) return Swal.fire('Error', error.message, 'error');

    let finalRows = [];
    const attendanceMap = new Set(attendanceData.map(item => `${item.work_date}_${item.fullname}`));
    
    attendanceData.forEach(row => finalRows.push(row));

    if (filterName !== 'ALL' && filterShift === 'ALL') {
        const daysInMonth = new Date(filterMonth.split('-')[0], filterMonth.split('-')[1], 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${filterMonth}-${String(d).padStart(2, '0')}`;
            if (!attendanceMap.has(`${dateStr}_${filterName}`)) {
                const absentRow = {
                    id: 'absent_' + dateStr, 
                    work_date: dateStr, shift: '-', id_card: '-', fullname: filterName,
                    time_in: null, time_out: null, 
                    remark_type: '<span class="badge bg-light text-secondary border px-2 py-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</span>', 
                    remark_detail: '-'
                };
                finalRows.push(absentRow);
            }
        }
    }

    const storageKey = `table_order_${filterMonth}_${filterName}_${filterShift}`;
    const savedOrderStr = localStorage.getItem(storageKey);
    
    if (savedOrderStr) {
        const savedOrder = JSON.parse(savedOrderStr);
        finalRows.sort((a, b) => {
            const indexA = savedOrder.indexOf(String(a.id));
            const indexB = savedOrder.indexOf(String(b.id));
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA !== -1) return -1;
            if (indexB !== -1) return 1;
            return 0;
        });
    } else {
        finalRows.sort((a, b) => new Date(a.work_date) - new Date(b.work_date));
    }

    const tbody = document.getElementById('attendanceTbody');
    tbody.innerHTML = '';
    
    finalRows.forEach(row => {
        const isAbsent = String(row.id).startsWith('absent');
        renderRow(row, tbody, isAbsent);
    });

    const switches = document.querySelectorAll('[id^="colSwitch_"]');
    switches.forEach((sw, idx) => toggleColumn(idx, sw.checked));

    updateKPIs(attendanceData.length, attendanceData.filter(r => r.shift.includes('‡πÄ‡∏ä‡πâ‡∏≤')).length, 
               attendanceData.filter(r => r.shift.includes('‡∏î‡∏∂‡∏Å')).length, attendanceData.filter(r => r.remark_type !== '‡∏õ‡∏Å‡∏ï‡∏¥').length);

    if (sortableInstance) sortableInstance.destroy();
    sortableInstance = new Sortable(tbody, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function () {
            document.getElementById('btnSaveOrder').classList.remove('d-none');
        }
    });
}

function renderRow(row, tbody, isAbsent) {
    const profileImg = row.profile_pic ? `<img src="${row.profile_pic}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover;" class="me-2 no-print border shadow-sm">` : '';
    
    let detailText = '';
    if (row.remark_detail && String(row.remark_detail).toLowerCase() !== 'null' && row.remark_detail !== '-') {
        detailText = row.remark_detail;
    }
    const remarkDetailHtml = detailText ? `<span class="text-muted d-block small mt-1">${detailText}</span>` : '';

    tbody.innerHTML += `
        <tr class="${isAbsent ? 'bg-light opacity-75' : ''}" data-id="${row.id}" title="‡∏à‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ">
            <td data-col="date" class="fw-bold text-muted">${row.work_date}</td>
            <td data-col="shift">${row.shift}</td>
            <td data-col="id_card"><span class="badge bg-light text-dark border">${row.id_card}</span></td>
            <td data-col="name" class="fw-bold">${profileImg}${row.fullname}</td>
            <td data-col="time_in" class="text-center fw-bold text-success">${row.time_in || '-'}</td>
            <td data-col="time_out" class="text-center fw-bold text-danger">${row.time_out || '-'}</td>
            <td data-col="remark">${row.remark_type} ${remarkDetailHtml}</td>
            <td data-col="action" class="text-center no-print">
                ${isAbsent ? '-' : `<button onclick="editTime('${row.id}', '${row.time_in}', '${row.time_out}')" class="btn btn-sm btn-light border text-primary px-3 rounded-pill"><i class="bi bi-pencil-square"></i></button>`}
            </td>
        </tr>`;
}

function saveRowOrder() {
    Toast.fire({ icon: 'info', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...' });
    
    setTimeout(() => {
        const rows = document.querySelectorAll('#attendanceTbody tr');
        const orderIds = Array.from(rows).map(tr => tr.getAttribute('data-id'));
        
        const filterMonth = document.getElementById('filterMonth').value || 'ALL';
        const filterName = document.getElementById('filterName').value || 'ALL';
        const filterShift = document.getElementById('filterShift').value || 'ALL';
        const storageKey = `table_order_${filterMonth}_${filterName}_${filterShift}`;
        
        localStorage.setItem(storageKey, JSON.stringify(orderIds));

        document.getElementById('btnSaveOrder').classList.add('d-none');
        Toast.fire({ icon: 'success', title: '‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' });
    }, 600);
}

function updateKPIs(total, morning, night, issue) {
    document.getElementById('kpi-total').innerText = total;
    document.getElementById('kpi-morning').innerText = morning;
    document.getElementById('kpi-night').innerText = night;
    document.getElementById('kpi-issue').innerText = issue;

    const ctx = document.getElementById('shiftChart').getContext('2d');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if(shiftChartInstance) shiftChartInstance.destroy();
    
    const chartData = (total === 0) ? [1] : [morning, night, issue];
    const chartBg = (total === 0) ? ['#e2e8f0'] : ['#f59e0b', '#334155', '#ef4444'];

    shiftChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤', '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], datasets: [{ data: chartData, backgroundColor: chartBg, borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#f8fafc' : '#1e293b', font: { family: 'Sarabun' } }, display: total > 0 } } }
    });
}

// ================= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ =================
async function editTime(id, currentIn, currentOut) {
    const { value: formValues } = await Swal.fire({
        title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (Admin)',
        html: `
            <div class="text-start mt-3">
                <label class="form-label fw-bold text-muted small">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</label>
                <input id="swal-in" type="time" value="${currentIn}" class="form-control mb-3">
                <label class="form-label fw-bold text-muted small">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (OUT)</label>
                <input id="swal-out" type="time" value="${currentOut}" class="form-control">
            </div>
        `,
        focusConfirm: false, showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        customClass: { confirmButton: 'btn btn-primary px-4', cancelButton: 'btn btn-light border px-4' },
        buttonsStyling: false,
        preConfirm: () => { return { in: document.getElementById('swal-in').value, out: document.getElementById('swal-out').value } }
    });

    if (formValues) {
        Toast.fire({ icon: 'info', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...' });
        const { error } = await db.from('guard_attendance').update({ time_in: formValues.in || null, time_out: formValues.out || null, updated_at: new Date(), updated_by: 'Admin' }).eq('id', id);
        if (error) { Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error'); } 
        else { Toast.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' }); loadAttendance(); }
    }
}

// ================= EXPORT =================
function exportPDF() {
    const monthText = document.getElementById('filterMonth').value || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    const nameText = document.getElementById('filterName').options[document.getElementById('filterName').selectedIndex].text;
    const shiftText = document.getElementById('filterShift').options[document.getElementById('filterShift').selectedIndex].text;
    
    document.getElementById('printInfoLabel').innerText = `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthText} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${nameText} | ‡∏Å‡∏∞: ${shiftText}`;
    document.getElementById('reportPrintDate').innerText = new Date().toLocaleDateString('th-TH');
    
    setTimeout(() => { window.print(); }, 500);
}

function exportExcel() {
    let table = document.getElementById("attendanceTable");
    let wb = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
    XLSX.writeFile(wb, `Report_Attendance.xlsx`);
}

// ================= ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ MASTER DATA =================
async function loadMasterTables() {
    const { data: cards } = await db.from('security_card_master').select('*').order('card_number');
    const { data: persons } = await db.from('security_personnel_master').select('*').order('fullname');

    document.getElementById('cardTbody').innerHTML = cards?.map(c => `<tr><td class="fw-bold"><span class="badge bg-light text-dark border px-3 py-2 fs-6">${c.card_number}</span></td><td class="text-end"><button onclick="delMaster('card', '${c.id}', '${c.card_number}')" class="btn btn-sm btn-light border text-danger rounded-circle"><i class="bi bi-trash3"></i></button></td></tr>`).join('') || '';
    document.getElementById('personTbody').innerHTML = persons?.map(p => `<tr><td class="fw-bold text-muted">${p.fullname}</td><td class="text-end"><button onclick="delMaster('person', '${p.id}', '${p.fullname}')" class="btn btn-sm btn-light border text-danger rounded-circle"><i class="bi bi-trash3"></i></button></td></tr>`).join('') || '';
}

async function addMaster(type) {
    const isCard = type === 'card';
    const inputId = isCard ? 'new_card' : 'new_person';
    const val = document.getElementById(inputId).value.trim();
    if(!val) return;

    const { error } = await db.from(isCard ? 'security_card_master' : 'security_personnel_master').insert([ isCard ? { card_number: val } : { fullname: val } ]);
    if(!error) {
        document.getElementById(inputId).value = '';
        Toast.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
        loadMasterTables(); loadFilterNames(); 
    } else { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥', 'error'); }
}

async function delMaster(type, id, name) {
    Swal.fire({
        title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ${name}?`, text: "‡∏´‡∏≤‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await db.from(type === 'card' ? 'security_card_master' : 'security_personnel_master').delete().eq('id', id);
            Toast.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
            loadMasterTables(); loadFilterNames();
        }
    });
}
</script>
</body>
</html>