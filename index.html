<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Slipper Permit - TSH Safety</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
        :root {
            --primary-color: #1e3a8a;
            --accent-color: #3b82f6;
            --bg-color: #f1f5f9;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color);
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            color: #334155;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
        }

        .container { max-width: 500px; padding: 0 15px; }

        .premium-card {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px 25px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.8);
        }

        .premium-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .header-section { text-align: center; margin-bottom: 25px; }
        .header-title { font-weight: 800; color: #1e293b; font-size: 1.4rem; letter-spacing: -0.5px; }

        /* Profile Section Styles */
        .profile-area {
            text-align: center; margin-bottom: 20px;
        }
        .profile-img {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .profile-name { font-weight: 700; color: #1e3a8a; font-size: 1.1rem; }

        .form-label { 
            font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; 
            color: #475569; display: flex; align-items: center; gap: 8px;
        }
        .form-label i { color: var(--accent-color); }

        .form-control, .form-select, .ts-control {
            border-radius: 12px; border: 1px solid #e2e8f0; padding: 12px; font-size: 1rem; transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus, .ts-wrapper.focus .ts-control {
            border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none;
        }

        /* Checkbox & Radio Styles */
        .btn-check:checked + .btn-outline-primary {
            background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        .btn-outline-primary, .btn-outline-danger { border-radius: 12px; padding: 10px; font-weight: 600; }

        /* Custom Switch for Name Selection */
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }

        .btn-submit { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white; width: 100%; border-radius: 16px; padding: 16px; 
            border: none; font-weight: 700; font-size: 1.1rem; margin-top: 15px;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s; margin-bottom: env(safe-area-inset-bottom);
        }
        .btn-submit:active { transform: scale(0.98); }

        .other-input { display: none; margin-top: 10px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .ts-wrapper .ts-control { border-radius: 12px; padding: 12px; }
        .ts-dropdown { border-radius: 12px; margin-top: 5px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="premium-card">
        <div class="header-section">
            <div class="profile-area">
                <img id="profileImage" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="profile-img" alt="Profile">
                <div class="mt-2">
                    <h4 class="header-title">‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏ß‡∏°‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞</h4>
                    <p class="text-muted small mb-0">TSH Safety Management System</p>
                </div>
            </div>
        </div>

        <div class="alert alert-warning border-0 shadow-sm rounded-3 mb-4 d-flex align-items-center" style="background-color: #fffbeb; color: #b45309;">
            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
            <div class="small lh-sm">
                <strong>‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö:</strong> ‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô <br>‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
            </div>
        </div>

        <form id="slipperForm">
            <input type="hidden" id="userId">
            <input type="hidden" id="lineDisplayName"> 

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-person-badge"></i> ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label>
                
                <div class="d-flex align-items-center mb-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="useLineName" checked onchange="toggleNameInput()">
                        <label class="form-check-label small text-muted" for="useLineName">‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å LINE</label>
                    </div>
                </div>

                <input type="text" id="fullname" class="form-control bg-light" readonly placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..." required>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-upc-scan"></i> ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span class="text-danger">*</span></label>
                <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="6" id="empId" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)" required>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-buildings"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ) <span class="text-danger">*</span></label>
                <select id="section" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô...">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô...</option>
                    <option value="ACCOUNTING SEC.">ACCOUNTING SEC.</option>
                    <option value="COSTING & FIX ASSET SEC.">COSTING & FIX ASSET SEC.</option>
                    <option value="CUSTOMER SERVICE SEC.">CUSTOMER SERVICE SEC.</option>
                    <option value="ENGINEERING 1 SEC.">ENGINEERING 1 SEC.</option>
                    <option value="ENGINEERING 2 SEC.">ENGINEERING 2 SEC.</option>
                    <option value="FINANCIAL SEC.">FINANCIAL SEC.</option>
                    <option value="GOVERNMENT RELATION SEC.">GOVERNMENT RELATION SEC.</option>
                    <option value="HUMAN RESOURCES DEVELOPMENT SEC.">HUMAN RESOURCES DEVELOPMENT SEC.</option>
                    <option value="HUMAN RESOURCES MANAGEMENT SEC.">HUMAN RESOURCES MANAGEMENT SEC.</option>
                    <option value="INFORMATION TECHNOLOGY SEC.">INFORMATION TECHNOLOGY SEC.</option>
                    <option value="LOGISTICS & SALES DEPT.">LOGISTICS & SALES DEPT.</option>
                    <option value="MAINTENANCE SEC.">MAINTENANCE SEC.</option>
                    <option value="MARKETING SEC.">MARKETING SEC.</option>
                    <option value="MATERIAL CONTROL SEC.">MATERIAL CONTROL SEC.</option>
                    <option value="OUTSOURCE SEC">OUTSOURCE SEC</option>
                    <option value="PRODUCTION 1 SEC.">PRODUCTION 1 SEC.</option>
                    <option value="PRODUCTION 2 SEC.">PRODUCTION 2 SEC.</option>
                    <option value="PRODUCTION CONTROL SEC.">PRODUCTION CONTROL SEC.</option>
                    <option value="QUALITY ASSURANCE SEC.">QUALITY ASSURANCE SEC.</option>
                    <option value="SAFETY HEALTH & ENVIRONMENT SEC.">SAFETY HEALTH & ENVIRONMENT SEC.</option>
                    <option value="WAREHOUSE SEC.">WAREHOUSE SEC.</option>
                    <option value="OTHER">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)</option>
                </select>
                <div id="otherSectionArea" class="other-input">
                    <input type="text" id="otherSection" class="form-control mt-2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô">
                </div>
            </div>

            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label"><i class="bi bi-hash"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ <span class="text-danger">*</span></label>
                    <select id="cardNo" class="form-select" required>
                        <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
                        <script>for(let i=1; i<=30; i++) document.write(`<option value="No.${i}">No.${i}</option>`);</script>
                    </select>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label"><i class="bi bi-calendar4-week"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ <span class="text-danger">*</span></label>
                    <input type="date" id="requestDate" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="bi bi-arrow-left-right"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠</label>
                <div class="d-flex gap-2">
                    <input type="radio" class="btn-check" name="accessType" id="typeIn" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø" checked>
                    <label class="btn btn-outline-primary w-50" for="typeIn"><i class="bi bi-box-arrow-in-right me-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø</label>
                    <input type="radio" class="btn-check" name="accessType" id="typeOut" value="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø">
                    <label class="btn btn-outline-danger w-50" for="typeOut"><i class="bi bi-box-arrow-left me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø</label>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label"><i class="bi bi-clipboard-pulse"></i> ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ <span class="text-danger">*</span></label>
                <select id="reasonSelect" class="form-select" onchange="toggleInput('reasonSelect', 'otherReasonArea')" required>
                    <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ --</option>
                    <option value="‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏Å‡∏±‡∏î / ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏•‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏ó‡πâ‡∏≤">‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏Å‡∏±‡∏î / ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏•‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏ó‡πâ‡∏≤</option>
                    <option value="‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö / ‡πÄ‡∏•‡πá‡∏ö‡∏Ç‡∏ö">‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö / ‡πÄ‡∏•‡πá‡∏ö‡∏Ç‡∏ö</option>
                    <option value="‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (‡∏°‡∏µ‡∏ö‡∏≤‡∏î‡πÅ‡∏ú‡∏•)">‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (‡∏°‡∏µ‡∏ö‡∏≤‡∏î‡πÅ‡∏ú‡∏•)</option>
                    <option value="‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤ (‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á)">‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤ (‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á)</option>
                    <option value="OTHER">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏)</option>
                </select>
                <div id="otherReasonArea" class="other-input">
                    <textarea id="otherReason" class="form-control mt-2" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
                </div>
            </div>

            <button type="submit" id="btnSubmit" class="btn-submit">
                ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <i class="bi bi-send-fill ms-2"></i>
            </button>
        </form>
    </div>
</div>

<script>
// CONFIG
const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U';
const LIFF_ID = '2007053300-s20OjYXq';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let sectionSelect; 
let authReady = false;

// ================= AUTH =================
async function ensureAuth() {
    const { data } = await db.auth.getSession();
    if (!data.session) {
        const res = await db.auth.signInAnonymously();
        if (res.error) {
            Swal.fire('Auth error', res.error.message, 'error');
            return false;
        }
    }
    authReady = true;
    return true;
}
ensureAuth();

// ================= UI HELPER =================
function toggleInput(selectId, areaId) {
    const select = document.getElementById(selectId);
    const area = document.getElementById(areaId);
    const input = area.querySelector('input, textarea');
    if (select.value === 'OTHER') {
        area.style.display = 'block'; input.required = true; setTimeout(() => input.focus(), 100);
    } else {
        area.style.display = 'none'; input.required = false; input.value = '';
    }
}

// üåü FEATURE: Toggle Name Input (Switch ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå/‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)
function toggleNameInput() {
    const isChecked = document.getElementById('useLineName').checked;
    const nameInput = document.getElementById('fullname');
    const lineName = document.getElementById('lineDisplayName').value;

    if (isChecked) {
        nameInput.value = lineName;
        nameInput.readOnly = true;
        nameInput.classList.add('bg-light');
    } else {
        nameInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
        nameInput.readOnly = false;
        nameInput.classList.remove('bg-light');
        nameInput.focus();
    }
}

// ================= INITIALIZATION =================
window.onload = async () => {
    // 1. Setup Date
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('requestDate');
    dateInput.value = today;
    dateInput.min = today;

    // 2. Setup Tom Select
    sectionSelect = new TomSelect("#section", {
        create: false,
        sortField: { field: "text", direction: "asc" },
        onChange: function(value) { toggleInput('section', 'otherSectionArea'); }
    });

    // 3. Auto-Fill Data
    const savedEmpId = localStorage.getItem('saved_empId');
    const savedSection = localStorage.getItem('saved_section');
    if (savedEmpId) document.getElementById('empId').value = savedEmpId;
    if (savedSection) sectionSelect.setValue(savedSection);

    // 4. Init LIFF & Profile
    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        const profile = await liff.getProfile();
        
        // Set Values
        document.getElementById('userId').value = profile.userId;
        document.getElementById('lineDisplayName').value = profile.displayName; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ
        document.getElementById('fullname').value = profile.displayName; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        document.getElementById('fullname').classList.remove('bg-light'); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å UI ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à

        // üåü FEATURE: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        if (profile.pictureUrl) {
            document.getElementById('profileImage').src = profile.pictureUrl;
        }

    } catch (err) {
        console.error('LIFF Error:', err);
    }
};

// ================= SUBMIT HANDLER =================
document.getElementById('slipperForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (navigator.vibrate) navigator.vibrate(50);
    if (!authReady) {
        const ok = await ensureAuth();
        if (!ok) return;
    }

    // Data Preparation
    let section = document.getElementById('section').value;
    if (section === 'OTHER') section = document.getElementById('otherSection').value;
    let reason = document.getElementById('reasonSelect').value;
    if (reason === 'OTHER') reason = document.getElementById('otherReason').value;

    const formData = {
        line_user_id: document.getElementById('userId').value,
        fullname: document.getElementById('fullname').value, // ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Line ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)
        emp_id: document.getElementById('empId').value,
        section,
        card_no: document.getElementById('cardNo').value,
        reason,
        access_type: document.querySelector('input[name="accessType"]:checked').value,
        request_date: document.getElementById('requestDate').value,
        status: 'Pending'
    };

    const confirm = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        html: `
            <div class="text-start fs-6 p-3 bg-light rounded border">
                <div class="mb-1"><small class="text-muted">‡∏ä‡∏∑‡πà‡∏≠:</small> <strong>${formData.fullname}</strong></div>
                <div class="mb-1"><small class="text-muted">‡∏£‡∏´‡∏±‡∏™:</small> <strong>${formData.emp_id}</strong></div>
                <div class="mb-1"><small class="text-muted">‡πÅ‡∏ú‡∏ô‡∏Å:</small> <strong>${formData.section}</strong></div>
                <div class="mb-1"><small class="text-muted">‡∏ö‡∏±‡∏ï‡∏£:</small> <span class="badge bg-primary rounded-pill">${formData.card_no}</span></div>
                <div class="mb-0"><small class="text-muted">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</small> ${formData.reason}</div>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á',
        cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
        confirmButtonColor: '#1e3a8a',
        cancelButtonColor: '#64748b',
        reverseButtons: true
    });

    if (!confirm.isConfirmed) return;

    const btn = document.getElementById('btnSubmit');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    try {
        const { error } = await db.from('slipper_requests').insert([formData])
        if (error) throw error

        localStorage.setItem('saved_empId', formData.emp_id);
        localStorage.setItem('saved_section', formData.section);

        if (liff.isInClient()) {
            try {
                await liff.sendMessages([{
                    type: 'text',
                    text: `üìù ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö\n(‡∏£‡∏´‡∏±‡∏™: ${formData.emp_id} / ${formData.section})`
                }]);
            } catch (msgErr) { console.log('Send msg failed:', msgErr); }
        }

        await Swal.fire({
            icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', text: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏ú‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
            timer: 2000, showConfirmButton: false
        });

        if (liff.isInClient()) liff.closeWindow();
        else window.location.reload();

    } catch (err) {
        Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
</script>
</body>
</html>