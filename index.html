<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏ß‡∏°‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞ ü©¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #fef2f2; }
        .form-card { max-width: 500px; margin: 20px auto; padding: 25px; background: white; border-radius: 16px; border-top: 5px solid #ef4444; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn-submit { background-color: #ef4444; color: white; width: 100%; border-radius: 50px; padding: 12px; border: none; font-weight: bold; }
        .required { color: red; }
    </style>
</head>
<body>
<div class="container">
    <div class="form-card">
        <h4 class="text-center fw-bold text-danger mb-3">ü©¥ ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏ß‡∏°‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞</h4>
        <form id="slipperForm">
            <input type="hidden" id="userId"><input type="hidden" id="lineName">
            
            <div class="mb-3"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label><input type="text" id="fullname" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span class="required">*</span></label><input type="text" id="empId" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å <span class="required">*</span></label><input type="text" id="section" class="form-control" required></div>
            
            <div class="mb-3">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å <span class="required">*</span></label>
                <select id="cardNo" class="form-select" required>
                    <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ --</option>
                    <script>for(let i=1; i<=20; i++) document.write(`<option value="No.${i}">Slipper Card No.${i}</option>`);</script>
                </select>
            </div>

            <div class="mb-3"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï <span class="required">*</span></label><input type="date" id="requestDate" class="form-control" required></div>
            <div class="mb-4"><label class="form-label">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ <span class="required">*</span></label><textarea id="reason" class="form-control" rows="2" required></textarea></div>

            <button type="submit" id="btnSubmit" class="btn-submit">üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
        </form>
    </div>
</div>

<script>
    // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç KEY ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚ö†Ô∏è
    const SUPABASE_URL = 'https://dqsfioiqwxuxpucwwhsv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2Zpb2lxd3h1eHB1Y3d3aHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTk1NjUsImV4cCI6MjA4NDE3NTU2NX0.L_u0Ff3uHofxiimEs6ySFB4TPNtOWiKeSu3KFoVcA1U'; 
    const LIFF_ID = 'YOUR_LIFF_ID'; 

    // ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö Library
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = async () => {
        document.getElementById('requestDate').valueAsDate = new Date();
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById('userId').value = profile.userId;
                document.getElementById('lineName').value = profile.displayName;
                // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å LINE ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                document.getElementById('fullname').value = profile.displayName;
            }
        } catch (err) {
            console.error('LIFF Error:', err);
        }
    };

    document.getElementById('slipperForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•
        btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; 
        btn.disabled = true;

        const formData = {
            user_id: document.getElementById('userId').value,
            fullname: document.getElementById('fullname').value,
            emp_id: document.getElementById('empId').value,
            section: document.getElementById('section').value,
            card_no: document.getElementById('cardNo').value,
            reason: document.getElementById('reason').value,
            request_date: document.getElementById('requestDate').value,
            status: 'Pending'
        };

        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà
        const { data, error } = await db.from('slipper_requests').insert([formData]).select();

        if (error) { 
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error'); 
            btn.innerHTML = 'üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠';
            btn.disabled = false; 
        } else {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏ö‡∏≠‡∏ó (Trigger)
            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: `REQ_SLIPPER_ID:${data[0].id}` }])
                    .then(() => liff.closeWindow())
                    .catch((err) => {
                        console.error(err);
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'success');
                    });
            } else {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô LINE)', 'success');
            }
        }
    });
</script>
</body>
</html>